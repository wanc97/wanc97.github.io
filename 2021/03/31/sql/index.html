<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="SQL, 方寸田园">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>SQL | 方寸田园</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="alternate" href="/atom.xml" title="方寸田园" type="application/atom+xml">
</head>




<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">方寸田园</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">方寸田园</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wanc97" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wanc97" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/image/SQL.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">SQL</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/SQL/">
                                <span class="chip bg-color">SQL</span>
                            </a>
                        
                            <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                <span class="chip bg-color">数据库</span>
                            </a>
                        
                            <a href="/tags/%E4%B8%BB%E9%94%AE/">
                                <span class="chip bg-color">主键</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" class="post-category">
                                编程语言
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-31
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-12-09
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    23.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    91 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>SQL（Structured Query Language 结构化查询语言）是数据库操作的标准</p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>数据库是将大量数据保存起来，通过计算机加工而成的可以进行高效访问的数据集合。该数据集合称为数据库（Database，DB）。用来管理数据库的计算机系统称为数据库管理系统（Database Management System，DBMS）。</p>
<h2 id="DBMS的种类"><a href="#DBMS的种类" class="headerlink" title="DBMS的种类"></a>DBMS的种类</h2><p>DBMS 主要通过数据的保存格式（数据库的种类）来进行分类，现阶段主要有以下 5 种类型.</p>
<ul>
<li>层次数据库（Hierarchical Database，HDB）</li>
<li>关系数据库（Relational Database，RDB）<ul>
<li>Oracle Database：甲骨文公司的RDBMS</li>
<li>SQL Server：微软公司的RDBMS</li>
<li>DB2：IBM公司的RDBMS</li>
<li>PostgreSQL：开源的RDBMS</li>
<li>MySQL：开源的RDBMS<br>如上是5种具有代表性的RDBMS，其特点是由行和列组成的二维表来管理数据，这种类型的 DBMS 称为关系数据库管理系统（Relational Database Management System，RDBMS）。</li>
</ul>
</li>
<li>面向对象数据库（Object Oriented Database，OODB）</li>
<li>XML数据库（XML Database，XMLDB）</li>
<li>键值存储系统（Key-Value Store，KVS），举例：MongoDB</li>
</ul>
<h2 id="RDBMS的常见系统结构"><a href="#RDBMS的常见系统结构" class="headerlink" title="RDBMS的常见系统结构"></a>RDBMS的常见系统结构</h2><p>最常见的系统结构就是客户端 / 服务器类型（C/S类型）<br><img src='/medias/image/2022-12-07-16-42-16.png' width="60%"></p>
<h2 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h2><p>数据库中存储的表结构类似于excel中的行和列，在数据库中，行称为<strong>记录</strong>，它相当于一条记录，列称为<strong>字段</strong>，它代表了表中存储的数据项目。</p>
<p>行和列交汇的地方称为单元格，一个单元格中只能输入一条记录。</p>
<p>SQL是为操作数据库而开发的语言。国际标准化组织（ISO）为 SQL 制定了相应的标准，以此为基准的SQL 称为标准 SQL。</p>
<p>完全基于标准 SQL 的 RDBMS 很少，通常需要根据不同的 RDBMS 来编写特定的 SQL 语句。</p>
<h2 id="语句种类"><a href="#语句种类" class="headerlink" title="语句种类"></a>语句种类</h2><p>根据对 RDBMS 赋予的指令种类的不同，SQL 语句可以分为以下三类.</p>
<ul>
<li><p><strong>DDL</strong> ：DDL（Data Definition Language，数据定义语言） 用来创建或者删除存储数据用的数据库以及数据库中的表等对象。DDL 包含以下几种指令。</p>
<ul>
<li>CREATE ： 创建数据库和表等对象</li>
<li>DROP ： 删除数据库和表等对象</li>
<li>ALTER ： 修改数据库和表等对象的结构</li>
</ul>
</li>
<li><p><strong>DML</strong> :DML（Data Manipulation Language，数据操纵语言） 用来查询或者变更表中的记录。DML 包含以下几种指令。</p>
<ul>
<li>SELECT ：查询表中的数据</li>
<li>INSERT ：向表中插入新数据</li>
<li>UPDATE ：更新表中的数据</li>
<li>DELETE ：删除表中的数据</li>
</ul>
</li>
<li><p><strong>DCL</strong> ：DCL（Data Control Language，数据控制语言） 用来确认或者取消对数据库中的数据进行的变更。除此之外，还可以对 RDBMS 的用户是否有权限操作数据库中的对象（数据库表等）进行设定。DCL 包含以下几种指令。</p>
<ul>
<li>COMMIT ： 确认对数据库中的数据进行的变更</li>
<li>ROLLBACK ： 取消对数据库中的数据进行的变更</li>
<li>GRANT ： 赋予用户操作权限</li>
<li>REVOKE ： 取消用户的操作权限</li>
</ul>
</li>
</ul>
<p>实际使用的 SQL 语句当中有 90% 属于 DML</p>
<h2 id="书写规则"><a href="#书写规则" class="headerlink" title="书写规则"></a>书写规则</h2><ul>
<li>SQL语句要以分号（ ; ）结尾</li>
<li>SQL 不区分关键字的大小写，但是插入到表中的数据是区分大小写的</li>
<li>win 系统默认不区分表名及字段名的大小写</li>
<li>linux / mac 默认严格区分表名及字段名的大小写</li>
<li>常数的书写方式是固定的</li>
</ul>
<p>‘abc’, 1234, ‘26 Jan 2010’, ‘10/01/26’, ‘2010-01-26’……</p>
<ul>
<li>单词需要用半角空格或者换行来分隔</li>
</ul>
<p>SQL 语句的单词之间需使用半角空格或换行符来进行分隔，且不能使用全角空格作为单词的分隔符，否则会发生错误，出现无法预期的结果。</p>
<h2 id="数据库的创建（-CREATE-DATABASE-语句）"><a href="#数据库的创建（-CREATE-DATABASE-语句）" class="headerlink" title="数据库的创建（ CREATE DATABASE 语句）"></a>数据库的创建（ CREATE DATABASE 语句）</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token operator">&lt;</span> 数据库名称 <span class="token operator">></span> <span class="token punctuation">;</span>
 
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> shop<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="表的创建（-CREATE-TABLE-语句）"><a href="#表的创建（-CREATE-TABLE-语句）" class="headerlink" title="表的创建（ CREATE TABLE 语句）"></a>表的创建（ CREATE TABLE 语句）</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span> 表名 <span class="token operator">></span>
<span class="token punctuation">(</span> <span class="token operator">&lt;</span> 列名 <span class="token number">1</span><span class="token operator">></span> <span class="token operator">&lt;</span> 数据类型 <span class="token operator">></span> <span class="token operator">&lt;</span> 该列所需约束 <span class="token operator">></span> <span class="token punctuation">,</span>
  <span class="token operator">&lt;</span> 列名 <span class="token number">2</span><span class="token operator">></span> <span class="token operator">&lt;</span> 数据类型 <span class="token operator">></span> <span class="token operator">&lt;</span> 该列所需约束 <span class="token operator">></span> <span class="token punctuation">,</span>
  <span class="token operator">&lt;</span> 列名 <span class="token number">3</span><span class="token operator">></span> <span class="token operator">&lt;</span> 数据类型 <span class="token operator">></span> <span class="token operator">&lt;</span> 该列所需约束 <span class="token operator">></span> <span class="token punctuation">,</span>
  <span class="token operator">&lt;</span> 列名 <span class="token number">4</span><span class="token operator">></span> <span class="token operator">&lt;</span> 数据类型 <span class="token operator">></span> <span class="token operator">&lt;</span> 该列所需约束 <span class="token operator">></span> <span class="token punctuation">,</span>
  <span class="token punctuation">.</span>
  <span class="token punctuation">.</span>
  <span class="token punctuation">.</span>
  <span class="token operator">&lt;</span> 该表的约束 <span class="token number">1</span><span class="token operator">></span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span> 该表的约束 <span class="token number">2</span><span class="token operator">></span> <span class="token punctuation">,</span>……<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> product
<span class="token punctuation">(</span>product_id <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
 product_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
 product_type <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
 sale_price <span class="token keyword">INTEGER</span> <span class="token punctuation">,</span>
 purchase_price <span class="token keyword">INTEGER</span> <span class="token punctuation">,</span>
 regist_date <span class="token keyword">DATE</span> <span class="token punctuation">,</span>
 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>product_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一个表中，将不同记录区分开的字段称为<strong>主键</strong><br>有时候由多个字段一起来区分记录，称为<strong>联合主键</strong><br>通过另一个表的主键联合两张表的字段称为<strong>外键</strong>，所以外键一定是某个表的主键</p>
<h2 id="数据类型的指定"><a href="#数据类型的指定" class="headerlink" title="数据类型的指定"></a>数据类型的指定</h2><p>数据库创建的表，所有的列都必须指定数据类型，每一列都不能存储与该列数据类型不符的数据。<br>四种最基本的数据类型</p>
<ul>
<li>INTEGER 型：用来指定存储整数的列的数据类型（数字型），不能存储小数。</li>
<li>CHAR 型：用来存储定长字符串，当列中存储的字符串长度达不到最大长度的时候，使用半角空格进行补足，由于会浪费存储空间，所以一般不使用。</li>
<li>VARCHAR 型：用来存储可变长度字符串，定长字符串在字符数未达到最大长度时会用半角空格补足，但可变长字符串不同，即使字符数未达到最大长度，也不会用半角空格补足。</li>
<li>DATE 型：用来指定存储日期（年月日）的列的数据类型（日期型）。</li>
</ul>
<h2 id="约束的设置"><a href="#约束的设置" class="headerlink" title="约束的设置"></a>约束的设置</h2><ul>
<li>约束是除了数据类型之外，对列中存储的数据进行限制或者追加条件的功能。</li>
<li><code>NOT NULL</code>是非空约束，即该列必须输入数据。</li>
<li><code>PRIMARY KEY</code>是主键约束，代表该列是唯一值，可以通过该列取出特定的行的数据。</li>
</ul>
<h2 id="表的删除和更新"><a href="#表的删除和更新" class="headerlink" title="表的删除和更新"></a>表的删除和更新</h2><ul>
<li>删除表的语法：<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span> 表名 <span class="token operator">></span> <span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
需要特别注意的是，删除的表是无法恢复的，只能重新插入，请执行删除操作时要特别谨慎。</li>
</ul>
<ul>
<li>添加列的 ALTER TABLE 语句</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span> 表名 <span class="token operator">></span> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token operator">&lt;</span> 列的定义 <span class="token operator">></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>添加一列可以存储100位的可变长字符串的 product_name_pinyin 列</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> product <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> product_name_pinyin <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>删除列的 ALTER TABLE 语句</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span> 表名 <span class="token operator">></span> <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> <span class="token operator">&lt;</span> 列名 <span class="token operator">></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>删除 product_name_pinyin 列</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> product <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> product_name_pinyin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>删除表中特定的行（语法）</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 一定注意添加 WHERE 条件，否则将会删除所有的数据</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> COLUMN_NAME<span class="token operator">=</span><span class="token string">'XXX'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ALTER TABLE 语句和 DROP TABLE 语句一样，执行之后无法恢复。误添加的列可以通过 ALTER TABLE 语句删除，或者将表全部删除之后重新再创建。</p>
<ul>
<li>清空表内容</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> TABLE_NAME<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>优点：相比<code>drop / delete</code>，<code>truncate</code>用来清除数据时，速度最快。</p>
<ul>
<li>数据的更新</li>
</ul>
<p>基本语法：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> <span class="token operator">&lt;</span>表名<span class="token operator">></span>
   <span class="token keyword">SET</span> <span class="token operator">&lt;</span>列名<span class="token operator">></span> <span class="token operator">=</span> <span class="token operator">&lt;</span>表达式<span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>列名<span class="token number">2</span><span class="token operator">>=</span><span class="token operator">&lt;</span>表达式<span class="token number">2</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>  
 <span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>条件<span class="token operator">></span>  <span class="token comment">-- 可选，非常重要</span>
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 子句  <span class="token comment">--可选</span>
 <span class="token keyword">LIMIT</span> 子句<span class="token punctuation">;</span> <span class="token comment">--可选</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>使用 update 时要注意添加 where 条件，否则将会将所有的行按照语句修改</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 修改所有的注册时间</span>
<span class="token keyword">UPDATE</span> product
   <span class="token keyword">SET</span> regist_date <span class="token operator">=</span> <span class="token string">'2009-10-10'</span><span class="token punctuation">;</span>  
<span class="token comment">-- 仅修改部分商品的单价</span>
<span class="token keyword">UPDATE</span> product
   <span class="token keyword">SET</span> sale_price <span class="token operator">=</span> sale_price <span class="token operator">*</span> <span class="token number">10</span>
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'厨房用具'</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 UPDATE 也可以将列更新为 NULL（该更新俗称为NULL清空）。此时只需要将赋值表达式右边的值直接写为 NULL 即可。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将商品编号为0008的数据（圆珠笔）的登记日期更新为NULL  </span>
<span class="token keyword">UPDATE</span> product
   <span class="token keyword">SET</span> regist_date <span class="token operator">=</span> <span class="token boolean">NULL</span>
 <span class="token keyword">WHERE</span> product_id <span class="token operator">=</span> <span class="token string">'0008'</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>和 INSERT 语句一样， UPDATE 语句也可以将 NULL 作为一个值来使用。<br><strong>但是，只有未设置 NOT NULL 约束和主键约束的列才可以清空为NULL。</strong>如果将设置了上述约束的列更新为 NULL，就会出错，这点与INSERT 语句相同。</p>
<p>多列更新</p>
<p>UPDATE 语句的 SET 子句支持同时将多个列作为更新对象。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 基础写法，一条UPDATE语句只更新一列</span>
<span class="token keyword">UPDATE</span> product
   <span class="token keyword">SET</span> sale_price <span class="token operator">=</span> sale_price <span class="token operator">*</span> <span class="token number">10</span>
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'厨房用具'</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> product
   <span class="token keyword">SET</span> purchase_price <span class="token operator">=</span> purchase_price <span class="token operator">/</span> <span class="token number">2</span>
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'厨房用具'</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该写法可以得到正确结果，但是代码较为繁琐。可以采用合并的方法来简化代码。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 合并后的写法</span>
<span class="token keyword">UPDATE</span> product
   <span class="token keyword">SET</span> sale_price <span class="token operator">=</span> sale_price <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span>
       purchase_price <span class="token operator">=</span> purchase_price <span class="token operator">/</span> <span class="token number">2</span>
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'厨房用具'</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要明确的是，SET 子句中的列不仅可以是两列，还可以是三列或者更多。</p>
<h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token operator">&lt;</span>表名<span class="token operator">></span> <span class="token punctuation">(</span>列<span class="token number">1</span><span class="token punctuation">,</span> 列<span class="token number">2</span><span class="token punctuation">,</span> 列<span class="token number">3</span><span class="token punctuation">,</span> ……<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span> 值<span class="token number">2</span><span class="token punctuation">,</span> 值<span class="token number">3</span><span class="token punctuation">,</span> ……<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对表进行全列 INSERT 时，可以省略表名后的列清单。这时 VALUES子句的值会默认按照从左到右的顺序赋给每一列。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> productins
<span class="token punctuation">(</span>product_id    <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
product_name   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
product_type   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
sale_price     <span class="token keyword">INTEGER</span>      <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
purchase_price <span class="token keyword">INTEGER</span> <span class="token punctuation">,</span>
regist_date    <span class="token keyword">DATE</span> <span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>product_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 
<span class="token comment">-- 包含列清单</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productins <span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> purchase_price<span class="token punctuation">,</span> regist_date<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0005'</span><span class="token punctuation">,</span> <span class="token string">'高压锅'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">6800</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">'2009-01-15'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 省略列清单</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0005'</span><span class="token punctuation">,</span> <span class="token string">'高压锅'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">6800</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">'2009-01-15'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>原则上，执行一次 INSERT 语句会插入一行数据。插入多行时，通常需要循环执行相应次数的 INSERT 语句。其实很多 RDBMS 都支持一次插入多行数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 通常的INSERT</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0002'</span><span class="token punctuation">,</span> <span class="token string">'打孔器'</span><span class="token punctuation">,</span> <span class="token string">'办公用品'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token string">'2009-09-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0003'</span><span class="token punctuation">,</span> <span class="token string">'运动T恤'</span><span class="token punctuation">,</span> <span class="token string">'衣服'</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0004'</span><span class="token punctuation">,</span> <span class="token string">'菜刀'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 多行INSERT （ DB2、SQL、SQL Server、 PostgreSQL 和 MySQL多行插入）</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0002'</span><span class="token punctuation">,</span> <span class="token string">'打孔器'</span><span class="token punctuation">,</span> <span class="token string">'办公用品'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token string">'2009-09-11'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token punctuation">(</span><span class="token string">'0003'</span><span class="token punctuation">,</span> <span class="token string">'运动T恤'</span><span class="token punctuation">,</span> <span class="token string">'衣服'</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token punctuation">(</span><span class="token string">'0004'</span><span class="token punctuation">,</span> <span class="token string">'菜刀'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">-- Oracle中的多行INSERT</span>
<span class="token keyword">INSERT</span> <span class="token keyword">ALL</span> <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0002'</span><span class="token punctuation">,</span> <span class="token string">'打孔器'</span><span class="token punctuation">,</span> <span class="token string">'办公用品'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token string">'2009-09-11'</span><span class="token punctuation">)</span>
           <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0003'</span><span class="token punctuation">,</span> <span class="token string">'运动T恤'</span><span class="token punctuation">,</span> <span class="token string">'衣服'</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
           <span class="token keyword">INTO</span> productins <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0004'</span><span class="token punctuation">,</span> <span class="token string">'菜刀'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DUAL<span class="token punctuation">;</span>  
<span class="token comment">-- DUAL是Oracle特有（安装时的必选项）的一种临时表A。因此“SELECT *FROM DUAL” 部分也只是临时性的，并没有实际意义。  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>INSERT 语句中想给某一列赋予 NULL 值时，可以直接在 VALUES子句的值清单中写入 NULL。想要插入 NULL 的列一定不能设置 NOT NULL 约束。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productins <span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> purchase_price<span class="token punctuation">,</span> regist_date<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'0006'</span><span class="token punctuation">,</span> <span class="token string">'叉子'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>还可以向表中插入默认值（初始值）。可以通过在创建表的CREATE TABLE 语句中设置DEFAULT约束来设定默认值。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> productins
<span class="token punctuation">(</span>product_id <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
（略）
sale_price <span class="token keyword">INTEGER</span>
（略）	<span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">-- 销售单价的默认值设定为0;</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>product_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以使用INSERT … SELECT 语句从其他表复制数据。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将商品表中的数据复制到商品复制表中</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> productcopy <span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> purchase_price<span class="token punctuation">,</span> regist_date<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> purchase_price<span class="token punctuation">,</span> regist_date
  <span class="token keyword">FROM</span> Product<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span> DML ：插入数据
STARTTRANSACTION<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0001'</span><span class="token punctuation">,</span> <span class="token string">'T恤衫'</span><span class="token punctuation">,</span> <span class="token string">'衣服'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0002'</span><span class="token punctuation">,</span> <span class="token string">'打孔器'</span><span class="token punctuation">,</span> <span class="token string">'办公用品'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token string">'2009-09-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0003'</span><span class="token punctuation">,</span> <span class="token string">'运动T恤'</span><span class="token punctuation">,</span> <span class="token string">'衣服'</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0004'</span><span class="token punctuation">,</span> <span class="token string">'菜刀'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0005'</span><span class="token punctuation">,</span> <span class="token string">'高压锅'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">6800</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">'2009-01-15'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0006'</span><span class="token punctuation">,</span> <span class="token string">'叉子'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0007'</span><span class="token punctuation">,</span> <span class="token string">'擦菜板'</span><span class="token punctuation">,</span> <span class="token string">'厨房用具'</span><span class="token punctuation">,</span> <span class="token number">880</span><span class="token punctuation">,</span> <span class="token number">790</span><span class="token punctuation">,</span> <span class="token string">'2008-04-28'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'0008'</span><span class="token punctuation">,</span> <span class="token string">'圆珠笔'</span><span class="token punctuation">,</span> <span class="token string">'办公用品'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2009-11-11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="索引的作用"><a href="#索引的作用" class="headerlink" title="索引的作用"></a>索引的作用</h3><ul>
<li>MySQL索引的建立对于MySQL的高效运行是很重要的，索引可以大大提高MySQL的检索速度。</li>
<li>打个比方，如果合理的设计且使用索引的 MySQL 是一辆兰博基尼的话，那么没有设计和使用索引的 MySQL 就是一个人力三轮车。</li>
<li>拿汉语字典的目录页（索引）打比方，我们可以按拼音、笔画、偏旁部首等排序的目录（索引）快速查找到需要的字。</li>
<li>索引创建了一种有序的数据结构，采用二分法搜索数据时，1000多万的数据只要搜索23次，其效率是非常高效的。</li>
</ul>
<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><p>创建表时可以直接创建索引，语法如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mytable<span class="token punctuation">(</span>  
 
ID <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>   
 
username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  
 
<span class="token keyword">INDEX</span> <span class="token punctuation">[</span>indexName<span class="token punctuation">]</span> <span class="token punctuation">(</span>username<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>  
 
<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可以使用如下语句创建：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 方法1</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> indexName <span class="token keyword">ON</span> table_name <span class="token punctuation">(</span>column_name<span class="token punctuation">)</span>

<span class="token comment">-- 方法2</span>
<span class="token keyword">ALTER</span> <span class="token keyword">table</span> tableName <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> indexName<span class="token punctuation">(</span>columnName<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="索引分类"><a href="#索引分类" class="headerlink" title="索引分类"></a>索引分类</h3><ul>
<li>主键索引</li>
</ul>
<p>建立在主键上的索引被称为主键索引，一张数据表只能有一个主键索引，索引列值不允许有空值，通常在创建表时一起创建。</p>
<ul>
<li>唯一索引</li>
</ul>
<p>建立在UNIQUE字段上的索引被称为唯一索引，一张表可以有多个唯一索引，索引列值允许为空，列值中出现多个空值不会发生重复冲突。</p>
<ul>
<li>普通索引</li>
</ul>
<p>建立在普通字段上的索引被称为普通索引。</p>
<ul>
<li>前缀索引</li>
</ul>
<p>前缀索引是指对字符类型字段的前几个字符或对二进制类型字段的前几个bytes建立的索引，而不是在整个字段上建索引。前缀索引可以建立在类型为char、varchar、binary、varbinary的列上，可以大大减少索引占用的存储空间，也能提升索引的查询效率。</p>
<ul>
<li>全文索引</li>
</ul>
<p>利用“分词技术”实现在长文本中搜索关键字的一种索引。</p>
<p>语法：<code>SELECT * FROM article WHERE MATCH (col1，col2，...) AGAINST (expr [ search _ modifier ])</code></p>
<p>1、MySQL 5.6 以前的版本，只有 MyISAM 存储引擎支持全文索引；</p>
<p>2、MySQL 5.6 及以后的版本，MyISAM 和 InnoDB 存储引擎均支持全文索引;</p>
<p>3、只有字段的数据类型为 char、varchar、text 及其系列才可以建全文索引。</p>
<p>4、如果可能，请尽量先创建表并插入所有数据后再创建全文索引，而不要在创建表时就直接创建全文索引，因为前者比后者的全文索引效率要高。</p>
<ul>
<li>单列索引</li>
</ul>
<p>建立在单个列上的索引被称为单列索引。</p>
<ul>
<li>联合索引（复合索引、多列索引）</li>
</ul>
<p>建立在多个列上的索引被称为联合索引，又叫复合索引、组合索引。</p>
<h1 id="基础查询与排序"><a href="#基础查询与排序" class="headerlink" title="基础查询与排序"></a>基础查询与排序</h1><h2 id="选取数据"><a href="#选取数据" class="headerlink" title="选取数据"></a>选取数据</h2><h3 id="SELECT语句"><a href="#SELECT语句" class="headerlink" title="SELECT语句"></a>SELECT语句</h3><p>从表中选取数据时需要使用SELECT语句，也就是只从表中选出（SELECT）必要数据的意思。通过SELECT语句查询并选取出必要数据的过程称为匹配查询或查询（query）。</p>
<p>基本SELECT语句包含了SELECT和FROM两个子句（clause）。示例如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>列名<span class="token operator">></span><span class="token punctuation">,</span> 
  <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>表名<span class="token operator">></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>其中，SELECT子句中列举了希望从表中查询出的列的名称，而FROM子句则指定了选取出数据的表的名称。</p>
<h3 id="WHERE语句"><a href="#WHERE语句" class="headerlink" title="WHERE语句"></a>WHERE语句</h3><p>当不需要取出全部数据，而是选取出满足“商品种类为衣服”“销售单价在1000日元以上”等某些条件的数据时，使用WHERE语句。</p>
<p>SELECT 语句通过WHERE子句来指定查询数据的条件。在WHERE 子句中可以指定“某一列的值和这个字符串相等”或者“某一列的值大于这个数字”等条件。执行含有这些条件的SELECT语句，就可以查询出只符合该条件的记录了。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>列名<span class="token operator">></span><span class="token punctuation">,</span> ……
  <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>表名<span class="token operator">></span>
 <span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>条件表达式<span class="token operator">></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>比较下面两者输出结果的不同：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 用来选取product type列为衣服的记录的SELECT语句</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> product_type
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span><span class="token punctuation">;</span>
<span class="token comment">-- 也可以选取出不是查询条件的列（条件列与输出列不同）</span>
<span class="token keyword">SELECT</span> product_name
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="相关法则"><a href="#相关法则" class="headerlink" title="相关法则"></a>相关法则</h3><ul>
<li>星号（*）代表全部列的意思。</li>
<li>SQL中可以随意使用换行符，不影响语句执行（但不可插入空行）。</li>
<li>设定汉语别名时需要使用双引号（”）括起来。</li>
<li>在SELECT语句中使用DISTINCT可以删除重复行。</li>
<li>注释是SQL语句中用来标识说明或者注意事项的部分。分为1行注释”– “和多行注释两种”/*  */“。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 想要查询出全部列时，可以使用代表所有列的星号（*）。</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
  <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>表名<span class="token operator">></span>；
<span class="token comment">-- SQL语句可以使用AS关键字为列设定别名（用中文时需要双引号（“”））。</span>
<span class="token keyword">SELECT</span> product_id     <span class="token keyword">As</span> id<span class="token punctuation">,</span>
       product_name   <span class="token keyword">As</span> name<span class="token punctuation">,</span>
       purchase_price <span class="token keyword">AS</span> <span class="token string">"进货单价"</span>
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 使用DISTINCT删除product_type列中重复的数据</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> product_type
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="算术运算符和比较运算符"><a href="#算术运算符和比较运算符" class="headerlink" title="算术运算符和比较运算符"></a>算术运算符和比较运算符</h2><h3 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h3><p>SQL语句中可以使用的四则运算的主要运算符如下：</p>
<table>
<thead>
<tr>
<th align="left">含义</th>
<th align="left">运算符</th>
</tr>
</thead>
<tbody><tr>
<td align="left">加法</td>
<td align="left">+</td>
</tr>
<tr>
<td align="left">减法</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">乘法</td>
<td align="left">*</td>
</tr>
<tr>
<td align="left">除法</td>
<td align="left">/</td>
</tr>
</tbody></table>
<h3 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 选取出sale_price列为500的记录</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> product_type
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>SQL常见比较运算符如下：<br>| 运算符 | 含义        |<br>| :—– | :———- |<br>| =      | 和 ~ 相等   |<br>| &lt;&gt;     | 和 ~ 不相等 |<br>| &gt;=     | 大于等于 ~  |<br>| &gt;      | 大于 ~      |<br>| &lt;=     | 小于等于 ~  |<br>| &lt;      | 小于 ~      |</p>
<h3 id="常用法则"><a href="#常用法则" class="headerlink" title="常用法则"></a>常用法则</h3><ul>
<li>SELECT子句中可以使用常数或者表达式。</li>
<li>使用比较运算符时一定要注意不等号和等号的位置。</li>
<li>字符串类型的数据原则上按照字典顺序进行排序，不能与数字的大小顺序混淆。</li>
<li>希望选取NULL记录时，需要在条件表达式中使用IS NULL运算符。希望选取不是NULL的记录时，需要在条件表达式中使用IS NOT NULL运算符。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- SQL语句中也可以使用运算表达式</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> sale_price <span class="token operator">*</span> <span class="token number">2</span> <span class="token keyword">AS</span> <span class="token string">"sale_price x2"</span>
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- WHERE子句的条件表达式中也可以使用计算表达式</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> purchase_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">-</span> purchase_price <span class="token operator">>=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token comment">/* 对字符串使用不等号
首先创建chars并插入数据
选取出大于‘2’的SELECT语句*/</span>
<span class="token comment">-- DDL：创建表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> chars
（chr <span class="token keyword">CHAR</span>（<span class="token number">3</span>）<span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span>（chr））<span class="token punctuation">;</span>
<span class="token comment">-- 选取出大于'2'的数据的SELECT语句('2'为字符串)</span>
<span class="token keyword">SELECT</span> chr
  <span class="token keyword">FROM</span> chars
 <span class="token keyword">WHERE</span> chr <span class="token operator">></span> <span class="token string">'2'</span><span class="token punctuation">;</span>
<span class="token comment">-- 选取NULL的记录</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> purchase_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> purchase_price <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token comment">-- 选取不为NULL的记录</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> purchase_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> purchase_price <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h2><h3 id="NOT运算符"><a href="#NOT运算符" class="headerlink" title="NOT运算符"></a>NOT运算符</h3><p>想要表示 <code>不是……</code> 时，除了前文的&lt;&gt;运算符外，还存在另外一个表示否定、使用范围更广的运算符：NOT。</p>
<p>NOT不能单独使用，必须和其他查询条件组合起来使用。如下例：</p>
<p>选取出销售单价大于等于1000日元的记录</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">>=</span> <span class="token number">1000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>向上述 SELECT 语句的查询条件中添加NOT运算符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> <span class="token operator">NOT</span> sale_price <span class="token operator">>=</span> <span class="token number">1000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以看出，通过否定销售单价大于等于 1000 日元 （sale_price &gt;= 1000） 这个查询条件，选取出了销售单价小于 1000 日元的商品。也就是说 <code>NOT sale_price &gt;= 1000</code> 与 <code>sale_price &lt; 1000</code> 是等价的。</p>
<p>值得注意的是，虽然通过 NOT 运算符否定一个条件可以得到相反查询条件的结果，但是其可读性明显不如显式指定查询条件，因此，不可滥用该运算符。</p>
<h3 id="AND运算符和OR运算符"><a href="#AND运算符和OR运算符" class="headerlink" title="AND运算符和OR运算符"></a>AND运算符和OR运算符</h3><p>当希望同时使用多个查询条件时，可以使用AND或者OR运算符。<br>AND 相当于“并且”，类似数学中的取交集；<br>OR 相当于“或者”，类似数学中的取并集。</p>
<h3 id="通过括号优先处理"><a href="#通过括号优先处理" class="headerlink" title="通过括号优先处理"></a>通过括号优先处理</h3><p>如果要查找这样一个商品，该怎么处理？</p>
<blockquote>
<p>“商品种类为办公用品”并且“登记日期是 2009 年 9 月 11 日或者 2009 年 9 月 20 日”<br>理想结果为“打孔器”，但当你输入以下信息时，会得到错误结果</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将查询条件原封不动地写入条件表达式，会得到错误结果</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> regist_date
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'办公用品'</span>
   <span class="token operator">AND</span> regist_date <span class="token operator">=</span> <span class="token string">'2009-09-11'</span>
    <span class="token operator">OR</span> regist_date <span class="token operator">=</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>错误的原因是 <strong>AND 运算符优先于 OR 运算符</strong> ，想要优先执行OR运算，可以使用 <strong>括号</strong> ：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 通过使用括号让OR运算符先于AND运算符执行</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> product_type<span class="token punctuation">,</span> regist_date
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'办公用品'</span>
   <span class="token operator">AND</span> <span class="token punctuation">(</span> regist_date <span class="token operator">=</span> <span class="token string">'2009-09-11'</span>
        <span class="token operator">OR</span> regist_date <span class="token operator">=</span> <span class="token string">'2009-09-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="含有NULL时的真值"><a href="#含有NULL时的真值" class="headerlink" title="含有NULL时的真值"></a>含有NULL时的真值</h3><ul>
<li>NULL的真值结果既不为真，也不为假，因为并不知道这样一个值。</li>
<li>这时真值是除真假之外的第三种值——<strong>不确定</strong>（UNKNOWN）。一般的逻辑运算并不存在这第三种值。SQL 之外的语言也基本上只使用真和假这两种真值。与通常的逻辑运算被称为二值逻辑相对，只有 SQL 中的逻辑运算被称为三值逻辑。</li>
<li>AND和OR的左右只要有一个值为UNKNOWN，结果就为UNKNOWN。</li>
</ul>
<h2 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h2><h3 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h3><p>SQL中用于汇总的函数叫做聚合函数。以下五个是最常用的聚合函数：</p>
<ul>
<li>SUM：计算表中某数值列中的合计值</li>
<li>AVG：计算表中某数值列中的平均值</li>
<li>MAX：计算表中任意列中数据的最大值，包括文本类型和数字类型</li>
<li>MIN：计算表中任意列中数据的最小值，包括文本类型和数字类型</li>
<li>COUNT：计算表中的记录条数（行数）</li>
</ul>
<p>请使用 <code>shop</code> 数据库，执行以下 SQL 查询语句，理解并掌握聚合函数的常规用法：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 计算销售单价和进货单价的合计值</span>
<span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>purchase_price<span class="token punctuation">)</span> 
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 计算销售单价和进货单价的平均值</span>
<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>purchase_price<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 计算销售单价的最大值和最小值</span>
<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- MAX和MIN也可用于非数值型数据</span>
<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>regist_date<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span>regist_date<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 计算全部数据的行数（包含 NULL 所在行）</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 计算 NULL 以外数据的行数</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>purchase_price<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="DISTINCT"><a href="#DISTINCT" class="headerlink" title="DISTINCT"></a>DISTINCT</h3><p>当对整表进行聚合运算时，表中可能存在多行相同的数据，比如商品类型（product_type 列）。</p>
<p>在某些场景下，就不能直接使用聚合函数进行聚合运算了，必须搭配 <code>DISTINCT</code> 函数使用。</p>
<p>比如：要计算总共有几种咖啡类型在售，该怎么计算呢？</p>
<p>如前所述，<code>DISTINCT</code> 函数用于删除重复数据，应用 COUNT 聚合函数之前，加上 <code>DISTINCT</code> 关键字就可以实现需求。</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">SELECT COUNT(DISTINCT product_type)
  FROM product;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="聚合法则"><a href="#聚合法则" class="headerlink" title="聚合法则"></a>聚合法则</h3><ul>
<li>COUNT 聚合函数运算结果与参数有关，COUNT(*) / COUNT(1) 得到包含 NULL 值的所有行，COUNT(&lt;列名&gt;) 得到不包含 NULL 值的所有行。</li>
<li>聚合函数不处理包含 NULL 值的行，但是 COUNT(*) 除外。</li>
<li>MAX / MIN 函数适用于文本类型和数字类型的列，而 SUM / AVG 函数仅适用于数字类型的列。</li>
<li>在聚合函数的参数中使用 DISTINCT 关键字，可以得到删除重复值的聚合结果。</li>
</ul>
<h2 id="GROUP-BY"><a href="#GROUP-BY" class="headerlink" title="GROUP BY"></a>GROUP BY</h2><p>之前使用聚合函数都是会将整个表的数据进行处理，当你想将进行分组汇总时（即：将现有的数据按照某列来汇总统计），GROUP BY可以帮助你：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>列名<span class="token number">1</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span>列名<span class="token number">2</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>列名<span class="token number">3</span><span class="token operator">></span><span class="token punctuation">,</span> ……
  <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>表名<span class="token operator">></span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>列名<span class="token number">1</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>列名<span class="token number">2</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>列名<span class="token number">3</span><span class="token operator">></span><span class="token punctuation">,</span> ……<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>看一看是否使用GROUP BY语句的差异：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 按照商品种类统计数据行数</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type<span class="token punctuation">;</span>
 <span class="token comment">-- 不含GROUP BY</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样，GROUP BY 子句就像切蛋糕那样将表进行了分组。在 GROUP BY 子句中指定的列称为<strong>聚合键</strong>或者<strong>分组列</strong>。</p>
<h3 id="聚合键中包含NULL时"><a href="#聚合键中包含NULL时" class="headerlink" title="聚合键中包含NULL时"></a>聚合键中包含NULL时</h3><p>将进货单价（purchase_price）作为聚合键举例：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> purchase_price<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> purchase_price<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时会将NULL作为一组特殊数据进行聚合运算</p>
<h3 id="书写位置"><a href="#书写位置" class="headerlink" title="书写位置"></a>书写位置</h3><p>GROUP BY的子句书写顺序有严格要求，不按要求会导致SQL无法正常执行，目前出现过的子句顺序为：</p>
<ol>
<li>SELECT :arrow_right:     </li>
<li>FROM :arrow_right:</li>
<li>WHERE :arrow_right:</li>
<li>GROUP BY</li>
</ol>
<p>其中前三项用于筛选数据，GROUP BY对筛选出的数据进行处理</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> purchase_price<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> purchase_price<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h3><p>在使用聚合函数及GROUP BY子句时，经常出现的错误有：</p>
<ol>
<li>在聚合函数的SELECT子句中写了聚合键以外的列使用COUNT等聚合函数时，SELECT子句中如果出现列名，只能是GROUP BY子句中指定的列名（也就是聚合键）。</li>
<li>在GROUP BY子句中使用列的别名SELECT子句中可以通过AS来指定别名，但在GROUP BY中不能使用别名。因为在DBMS中 ,SELECT子句在GROUP BY子句后执行。</li>
<li>在WHERE中使用聚合函数原因是聚合函数的使用前提是结果集已经确定，而WHERE还处于确定结果集的过程中，所以相互矛盾会引发错误。 如果想指定条件，可以在SELECT，HAVING（下面马上会讲）以及ORDER BY子句中使用聚合函数。</li>
</ol>
<h2 id="HAVING"><a href="#HAVING" class="headerlink" title="HAVING"></a>HAVING</h2><p>将表使用 GROUP BY 分组后，怎样才能只取出其中两组？<br>这里 WHERE 不可行，因为，WHERE子句只能指定记录（行）的条件，而不能用来指定组的条件（例如，“数据行数为 2 行”或者“平均值为 500”等）。<br>可以在 GROUP BY 后使用 HAVING 子句。<br>HAVING 的用法类似 WHERE。<br>值得注意的是：HAVING 子句必须与 GROUP BY 子句配合使用，且限定的是分组聚合结果，WHERE 子句是限定数据行（包括分组列），二者各司其职，不要混淆。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>HAVING子句用于对分组进行过滤，可以使用常数、聚合函数和GROUP BY中指定的列名（聚合键）。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 常数</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">-- 错误形式（因为product_name不包含在GROUP BY聚合键中）</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type
<span class="token keyword">HAVING</span> product_name <span class="token operator">=</span> <span class="token string">'圆珠笔'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ORDER-BY"><a href="#ORDER-BY" class="headerlink" title="ORDER BY"></a>ORDER BY</h2><p>在某些场景下，需要得到一个排序之后的结果，比如运动员在奥运赛场的得分，组委会用得分倒序结果来判定金银铜牌到底花落谁家。而 SQL 语句执行结果默认随机排列，想要按照顺序排序，需使用 <strong>ORDER BY</strong> 子句。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>列名<span class="token number">1</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>列名<span class="token number">2</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>列名<span class="token number">3</span><span class="token operator">></span><span class="token punctuation">,</span> ……
  <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>表名<span class="token operator">></span>
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>排序基准列<span class="token number">1</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token keyword">DESC</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>排序基准列<span class="token number">2</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token keyword">DESC</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ……<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>其中，参数 ASC 表示升序排列，DESC 表示降序排列，默认为升序，此时，参数 ASC 可以缺省。<br>如下代码将得到按照销售价格倒序排列的查询结果：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 降序排列</span>
<span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> purchase_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sale_price <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果有多列排序需求，只需在 ORDER BY 子句中依次书写排序列 + 排序参数即可，详见如下代码：</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">-- 多个排序键
SELECT product_id, product_name, sale_price, purchase_price
  FROM product
 ORDER BY sale_price, product_id;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要特别说明的是：由于 NULL 无法使用比较运算符进行比较，也就是说，无法与文本类型，数字类型，日期类型等进行比较，当排序列存在 NULL 值时，NULL 结果会展示在查询结果的开头或者末尾。</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">-- 当用于排序的列名中含有NULL时，NULL会在开头或末尾进行汇总。
SELECT product_id, product_name, sale_price, purchase_price
  FROM product
 ORDER BY purchase_price;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ORDER-BY使用别名"><a href="#ORDER-BY使用别名" class="headerlink" title="ORDER BY使用别名"></a>ORDER BY使用别名</h3><p>前文讲GROUP BY中提到，GROUP BY 子句中不能使用SELECT 子句中定义的别名，但是在 ORDER BY 子句中却可以使用别名。为什么在GROUP BY中不可以而在ORDER BY中可以呢？<br>这是因为 SQL 在使用 HAVING 子句时 SELECT 语句的执行顺序为：<br>FROM → WHERE → GROUP BY → SELECT → HAVING → ORDER BY<br>其中 SELECT 的执行顺序在 GROUP BY 子句之后，ORDER BY 子句之前。<br>当在 ORDER BY 子句中使用别名时，已经知道了 SELECT 子句设置的别名，但是在 GROUP BY 子句执行时还不知道别名的存在，所以在 ORDER BY 子句中可以使用别名，但是在GROUP BY中不能使用别名。</p>
<h3 id="ORDER-BY-NULL"><a href="#ORDER-BY-NULL" class="headerlink" title="ORDER BY  NULL"></a>ORDER BY  NULL</h3><p>在MySQL中，<code>NULL</code> 值被认为比任何 <code>非NULL</code> 值低，因此，当顺序为 ASC（升序）时，<code>NULL</code> 值出现在第一位，而当顺序为 DESC（降序）时，则排序在最后。<br>如果想指定存在 <code>NULL</code> 的行出现在首行或者末行，需要特殊处理。<br>使用如下代码构建示例表：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    date_login <span class="token keyword">DATE</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">user</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> date_login<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token string">'2017-03-12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token string">'john'</span><span class="token punctuation">,</span>   <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token string">'david'</span><span class="token punctuation">,</span> <span class="token string">'2016-12-24'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token string">'zayne'</span><span class="token punctuation">,</span> <span class="token string">'2017-03-02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>既然排序时，<code>NULL</code> 的值比 <code>非NULL</code> 值低（可以理解为 <code>0</code> 或者 <code>-∞</code>），那么我们在排序时就要对这个默认情况进行特殊处理以达到想要的效果。</p>
<p>一般有如下两种需求：</p>
<ul>
<li>将 <code>NULL</code> 值排在末行，同时将所有 <code>非NULL</code> 值按升序排列。</li>
</ul>
<p>对于数字或者日期类型，可以在排序字段前添加一个负号（minus）来得到反向排序。（<code>-1、-2、-3....-∞</code>）</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM user 
 ORDER BY -date_login DESC;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于字符型或者字符型数字，此方法不一定能得到期望的排序结果，可以使用 <code>IS NULL</code> 比较运算符。另外 <code>ISNULL( )</code> 函数等同于使用 <code>IS NULL</code> 比较运算符。</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">-- IS NULL
SELECT * FROM user 
 ORDER BY name IS NULL ASC,name ASC;
 
-- ISNULL()
SELECT * FROM user 
 ORDER BY ISNULL(name) ASC,name ASC;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述语句先使用 <code>ISNULL(name)</code> 字段进行升序排列，而只有当 <code>name</code> 列值为 <code>NULL</code> 时，<code>ISNULL(name)</code> 才为真，所以其排到末行，而 <code>name ASC</code> 则实现了 <code>非NULL</code> 值升序排列。<br>还可以使用 <code>COALESCE</code> 函数实现需求</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM user 
 ORDER BY COALESCE(name, &#39;zzzzz&#39;) ASC;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>将 <code>NULL</code> 值排在首行，同时将所有 <code>非NULL</code> 值按倒序排列。<br>对于数字或者日期类型，可以在排序字段前添加一个负号（minus）来实现。（<code>-∞...-3、-2、-1</code>）</li>
</ul>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM user 
 ORDER BY -date_login ASC;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于字符型或者字符型数字，此方法不一定能得到期望的排序结果，可以使用 <code>IS NOT NULL</code> 比较运算符。另外 <code>!ISNULL( )</code> 函数等同于使用 <code>IS NOT NULL</code> 比较运算符。</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">-- IS NOT NULL
SELECT * FROM user 
 ORDER BY name IS NOT NULL ASC,name DESC;

-- !ISNULL()
SELECT * FROM user 
 ORDER BY !ISNULL(name) ASC,name DESC;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述语句先使用 <code>!ISNULL(name)</code> 字段进行升序排列，而只有当 <code>name</code> 列值不为 <code>NULL</code> 时，<code>!ISNULL(name)</code> 才为真，所以其排到说行，而 <code>name DESC</code> 则实现了 <code>非NULL</code> 值降序排列。</p>
<p>还可以使用 <code>COALESCE</code> 函数实现需求</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">SELECT * FROM user 
 ORDER BY COALESCE(name, &#39;zzzzz&#39;) DESC;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h1 id="复杂查询"><a href="#复杂查询" class="headerlink" title="复杂查询"></a>复杂查询</h1><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name <span class="token keyword">FROM</span> view_product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>单从表面上看起来这个语句是和正常的从数据表中查询数据是完全相同的，但其实操作的是一个视图。<br>从SQL的角度来说操作视图与操作表看起来是完全相同的</p>
<h3 id="什么是视图"><a href="#什么是视图" class="headerlink" title="什么是视图"></a>什么是视图</h3><p>视图是一个虚拟的表，不同于直接操作数据表，视图是依据SELECT语句来创建的（会在下面具体介绍），所以操作视图时会根据创建视图的SELECT语句生成一张虚拟表，然后在这张虚拟表上做SQL操作。</p>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p>视图与表的区别：是否保存了实际的数据。<br>视图并不是数据库真实存储的数据表，它可以看作是一个窗口，通过这个窗口我们可以看到数据库表中真实存在的数据。所以我们要区别视图和数据表的本质，即视图是基于真实表的一张虚拟的表，其数据来源均建立在真实表的基础上。<br><img src='/medias/image/2022-12-08-11-07-51.png' width="100%"><br>视图不是表，视图是虚表，视图依赖于表</p>
<h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>那既然已经有数据表了，为什么还需要视图呢：</p>
<ol>
<li>通过定义视图可以将频繁使用的SELECT语句保存以提高效率。</li>
<li>通过定义视图可以使用户看到的数据更加清晰。</li>
<li>通过定义视图可以不对外公开数据表全部字段，增强数据的保密性。</li>
<li>通过定义视图可以降低数据的冗余。</li>
</ol>
<h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><p>说了这么多视图与表的区别，下面我们就一起来看一下如何创建视图吧。<br>创建视图的基本语法如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> <span class="token operator">&lt;</span>视图名称<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&lt;</span>列名<span class="token number">1</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span>列名<span class="token number">2</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token operator">&lt;</span><span class="token keyword">SELECT</span>语句<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中SELECT 语句需要书写在 AS 关键字之后。 SELECT 语句中列的排列顺序和视图中列的排列顺序相同， SELECT 语句中的第 1 列就是视图中的第 1 列， SELECT 语句中的第 2 列就是视图中的第 2 列，以此类推。而且视图的列名是在视图名称之后的列表中定义的。<br>需要注意的是视图名在数据库中需要是唯一的，不能与其他视图和表重名。<br>视图不仅可以基于真实表，我们也可以在视图的基础上继续创建视图。<br><img src='/medias/image/2022-12-08-11-10-31.png' width="80%"><br>虽然在视图上继续创建视图的语法没有错误，但是我们还是应该尽量避免这种操作。这是因为对多数 DBMS 来说， 多重视图会降低SQL的性能。</p>
<ul>
<li>注意事项：在一般的DBMS中定义视图时不能使用ORDER BY语句。<br>下面这样定义视图是错误的。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> productsum <span class="token punctuation">(</span>product_type<span class="token punctuation">,</span> cnt_product<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product_type<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
为什么不能使用ORDER BY子句呢？这是因为视图和表一样，<strong>数据行都是没有顺序的</strong>。</li>
</ul>
<p><em>在 MySQL中视图的定义是允许使用 ORDER BY 语句的，但是若从特定视图进行选择，而该视图使用了自己的 ORDER BY 语句，则视图定义中的 ORDER BY 将被忽略。</em></p>
<h4 id="基于单表的视图"><a href="#基于单表的视图" class="headerlink" title="基于单表的视图"></a>基于单表的视图</h4><p>我们在product表的基础上创建一个视图，如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> productsum <span class="token punctuation">(</span>product_type<span class="token punctuation">,</span> cnt_product<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建的视图如下图所示：</p>
<h4 id="基于多表的视图"><a href="#基于多表的视图" class="headerlink" title="基于多表的视图"></a>基于多表的视图</h4><p>在product表和shop_product表的基础上创建视图。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> view_shop_product<span class="token punctuation">(</span>product_type<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> shop_name<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> sale_price<span class="token punctuation">,</span> shop_name
  <span class="token keyword">FROM</span> product<span class="token punctuation">,</span>
       shop_product
 <span class="token keyword">WHERE</span> product<span class="token punctuation">.</span>product_id <span class="token operator">=</span> shop_product<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以在这个视图的基础上进行查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> sale_price<span class="token punctuation">,</span> shop_name
  <span class="token keyword">FROM</span> view_shop_product
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查询结果为：</p>
<h3 id="修改视图结构"><a href="#修改视图结构" class="headerlink" title="修改视图结构"></a>修改视图结构</h3><p>修改视图结构的基本语法如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> <span class="token operator">&lt;</span>视图名<span class="token operator">></span> <span class="token keyword">AS</span> <span class="token operator">&lt;</span><span class="token keyword">SELECT</span>语句<span class="token operator">></span>
 
<span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> productsum
    <span class="token keyword">AS</span>
        <span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> sale_price
          <span class="token keyword">FROM</span> Product
         <span class="token keyword">WHERE</span> regist_date <span class="token operator">></span> <span class="token string">'2009-09-11'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中视图名在数据库中需要是唯一的，不能与其他视图和表重名。<br>当然也可以通过将当前视图删除然后重新创建的方式达到修改的效果</p>
<h3 id="更新视图"><a href="#更新视图" class="headerlink" title="更新视图"></a>更新视图</h3><p>因为视图是一个虚拟表，所以对视图的操作就是对底层基础表的操作，所以在修改时只有满足底层基本表的定义才能成功修改。<br>对于一个视图来说，如果包含以下结构的任意一种都是不可以被更新的：</p>
<ul>
<li>聚合函数 SUM()、MIN()、MAX()、COUNT() 等。</li>
<li>DISTINCT 关键字。</li>
<li>GROUP BY 子句。</li>
<li>HAVING 子句。</li>
<li>UNION 或 UNION ALL 运算符。</li>
<li>FROM 子句中包含多个表。</li>
</ul>
<p>视图归根结底还是从表派生出来的，因此，如果原表可以更新，那么 视图中的数据也可以更新。反之亦然，如果视图发生了改变，而原表没有进行相应更新的话，就无法保证数据的一致性了。</p>
<ul>
<li>更新视图<br>因为我们刚刚修改的productsum视图不包括以上的限制条件，我们来尝试更新一下视图<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> productsum
   <span class="token keyword">SET</span> sale_price <span class="token operator">=</span> <span class="token string">'5000'</span>
 <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'办公用品'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
此时我们再查看 productsum 视图，可以发现数据已经更新了<br>此时观察原表也可以发现数据也被更新了<br>刚才修改视图的时候是设置product_type=’办公用品’的商品的sale_price=5000，原表的数据只有一条做了修改，还是因为视图的定义，视图只是原表的一个窗口，所以它修改也只能修改透过窗口能看到的内容。</li>
<li><em>注意：这里虽然修改成功了，但是并不推荐这种使用方式。而且我们在创建视图时也尽量使用限制不允许通过视图来修改表</em>*</li>
</ul>
<h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><p>删除视图的基本语法如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token operator">&lt;</span>视图名<span class="token number">1</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span>视图名<span class="token number">2</span><span class="token operator">></span> …<span class="token punctuation">]</span>
 
<span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> productsum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果我们继续操作这个视图的话就会提示当前操作的内容不存在。</p>
<h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> stu_name
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> stu_name<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> stu_cnt
    <span class="token keyword">FROM</span> students_info
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> stu_age
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> studentSum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个语句看起来很好理解，其中使用括号括起来的sql语句首先执行，执行成功后再执行外面的sql语句。但是我们上一节提到的视图也是根据SELECT语句创建视图然后在这个基础上再进行查询。那么什么是子查询呢？子查询和视图又有什么关系呢？</p>
<h3 id="什么是子查询"><a href="#什么是子查询" class="headerlink" title="什么是子查询"></a>什么是子查询</h3><p>子查询指一个查询语句嵌套在另一个查询语句内部的查询，这个特性从 MySQL 4.1 开始引入，在 SELECT 子句中先计算子查询，子查询结果作为外层另一个查询的过滤条件，查询可以基于一个表或者多个表。</p>
<h3 id="子查询和视图的关系"><a href="#子查询和视图的关系" class="headerlink" title="子查询和视图的关系"></a>子查询和视图的关系</h3><p>子查询就是将用来定义视图的 SELECT 语句直接用于 FROM 子句当中。其中AS studentSum可以看作是子查询的名称，而且由于子查询是一次性的，所以子查询不会像视图那样保存在存储介质中，而是在 SELECT 语句执行之后就消失了。</p>
<h3 id="嵌套子查询"><a href="#嵌套子查询" class="headerlink" title="嵌套子查询"></a>嵌套子查询</h3><p>与在视图上再定义视图类似，子查询也没有具体的限制，例如我们可以这样</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> cnt_product
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token operator">*</span>
        <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
                <span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> 
                      <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt_product
                <span class="token keyword">FROM</span> product 
                <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> productsum
        <span class="token keyword">WHERE</span> cnt_product <span class="token operator">=</span> <span class="token number">4</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> productsum2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中最内层的子查询我们将其命名为 productsum ，这条语句根据product_type分组并查询个数，第二层查询中将个数为4的商品查询出来，最外层查询product_type和cnt_product两列。<br><strong>虽然嵌套子查询可以查询出结果，但是随着子查询嵌套的层数的叠加，SQL语句不仅会难以理解而且执行效率也会很差，所以要尽量避免这样的使用。</strong></p>
<h3 id="标量子查询"><a href="#标量子查询" class="headerlink" title="标量子查询"></a>标量子查询</h3><p>标量就是单一的意思，那么标量子查询也就是单一的子查询<br>所谓单一就是要求我们执行的SQL语句只能返回一个值，也就是要返回表中具体的<strong>某一行的某一列</strong>。例如我们有下面这样一张表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">product_id <span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price 
<span class="token comment">------------+-------------+----------</span>
<span class="token number">0003</span>       <span class="token operator">|</span> 运动T恤       <span class="token operator">|</span> <span class="token number">4000</span> 
<span class="token number">0004</span>       <span class="token operator">|</span> 菜刀          <span class="token operator">|</span> <span class="token number">3000</span> 
<span class="token number">0005</span>       <span class="token operator">|</span> 高压锅        <span class="token operator">|</span> <span class="token number">6800</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么我们执行一次标量子查询后是要返回类似于，“0004”，“菜刀”这样的结果。</p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ol>
<li>查询出销售单价高于平均销售单价的商品</li>
<li>查询出注册日期最晚的那个商品</li>
</ol>
<p>让我们看如何通过标量子查询语句查询出销售单价高于平均销售单价的商品。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>上面的这条语句首先后半部分查询出product表中的平均售价，前面的sql语句在根据WHERE条件挑选出合适的商品。<br>由于标量子查询的特性，导致标量子查询不仅仅局限于 WHERE 子句中，通常任何可以使用单一值的位置都可以使用。也就是说， 能够使用常数或者列名的地方，无论是 SELECT 子句、GROUP BY 子句、HAVING 子句，还是 ORDER BY 子句，几乎所有的地方都可以使用。</p>
<p>我们还可以这样使用标量子查询：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span>
       product_name<span class="token punctuation">,</span>
       sale_price<span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span>
          <span class="token keyword">FROM</span> product<span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_price
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="关联子查询"><a href="#关联子查询" class="headerlink" title="关联子查询"></a>关联子查询</h3><ul>
<li>什么是关联子查询<br>关联子查询既然包含关联两个字，那么一定意味着查询与子查询之间存在着联系。这种联系是如何建立起来的呢？<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> p1
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span>
                       <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> p2
                      <span class="token keyword">WHERE</span> p1<span class="token punctuation">.</span>product_type <span class="token operator">=</span> p2<span class="token punctuation">.</span>product_type
                      <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
关联子查询就是通过一些标志将内外两层的查询连接起来起到过滤数据的目的。</li>
<li>关联子查询与子查询的联系<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询出销售单价高于平均销售单价的商品</span>
<span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 选取出各商品种类中高于该商品种类的平均销售单价的商品</span>
<span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> p1
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span>
                       <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> p2
                      <span class="token keyword">WHERE</span> p1<span class="token punctuation">.</span>product_type <span class="token operator">=</span>p2<span class="token punctuation">.</span>product_type
                      <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
在第二条SQL语句也就是关联子查询中我们将外面的product表标记为p1，将内部的product设置为p2，而且通过WHERE语句连接了两个查询。</li>
</ul>
<p>关联查询的执行过程：</p>
<ol>
<li>首先执行不带WHERE的主查询</li>
<li>根据主查询讯结果匹配product_type，获取子查询结果</li>
<li>将子查询结果再与主查询结合执行完整的SQL语句</li>
</ol>
<p><em>在子查询中像标量子查询，嵌套子查询或者关联子查询可以看作是子查询的一种操作方式即可。</em></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>视图和子查询是数据库操作中较为基础的内容，对于一些复杂的查询需要使用子查询加一些条件语句组合才能得到正确的结果。但是无论如何对于一个SQL语句来说都不应该设计的层数非常深且特别复杂，不仅可读性差而且执行效率也难以保证，所以尽量有简洁的语句来完成需要的功能。</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>sql 自带了各种各样的函数，极大提高了 sql 语言的便利性。<br>给它一个输入值，它便按照预设的程序定义给出返回值，输入值称为<code>参数</code>。</p>
<p>函数大致分为如下几类：</p>
<ul>
<li>算术函数    （用来进行数值计算的函数）</li>
<li>字符串函数 （用来进行字符串操作的函数）</li>
<li>日期函数     （用来进行日期操作的函数）</li>
<li>转换函数     （用来转换数据类型和值的函数）</li>
<li>聚合函数     （用来进行数据聚合的函数）</li>
</ul>
<p>函数总个数超过200个，不需要完全记住，常用函数有 30~50 个，其他不常用的函数使用时查阅文档即可。</p>
<h3 id="算数函数"><a href="#算数函数" class="headerlink" title="算数函数"></a>算数函数</h3><ul>
<li>ABS – 绝对值<br>语法：<code>ABS( 数值 )</code><br>ABS 函数用于计算一个数字的绝对值，表示一个数到原点的距离。<br>当 ABS 函数的参数为<code>NULL</code>时，返回值也是<code>NULL</code>。</li>
<li>MOD – 求余数<br>语法：<code>MOD( 被除数，除数 )</code><br>MOD 是计算除法余数（求余）的函数，是 modulo 的缩写。小数没有余数的概念，只能对整数列求余数。<br>注意：主流的 DBMS 都支持 MOD 函数，只有SQL Server 不支持该函数，其使用<code>%</code>符号来计算余数。</li>
<li>ROUND – 四舍五入<br>语法：<code>ROUND( 对象数值，保留小数的位数 )</code><br>ROUND 函数用来进行四舍五入操作。<br>注意：当参数 <strong>保留小数的位数</strong> 为变量时，可能会遇到错误，请谨慎使用变量。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> m<span class="token punctuation">,</span>
    ABS<span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token keyword">AS</span> abs_col <span class="token punctuation">,</span>
    n<span class="token punctuation">,</span> p<span class="token punctuation">,</span>
    <span class="token function">MOD</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token keyword">AS</span> mod_col<span class="token punctuation">,</span>
    <span class="token function">ROUND</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> round_col
<span class="token keyword">FROM</span> samplemath<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+---------+------+------+---------+-----------+</span>
<span class="token operator">|</span> m        <span class="token operator">|</span> abs_col <span class="token operator">|</span> n    <span class="token operator">|</span> p    <span class="token operator">|</span> mod_col <span class="token operator">|</span> round_col <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+---------+------+------+---------+-----------+</span>
<span class="token operator">|</span>  <span class="token number">500.000</span> <span class="token operator">|</span> <span class="token number">500.000</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>     <span class="token number">500.0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token operator">-</span><span class="token number">180.000</span> <span class="token operator">|</span> <span class="token number">180.000</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token operator">-</span><span class="token number">180.0</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">7</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">8.000</span> <span class="token operator">|</span>   <span class="token number">8.000</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>       <span class="token number">8.0</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2.270</span> <span class="token operator">|</span>   <span class="token number">2.270</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>       <span class="token number">2.3</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">5.555</span> <span class="token operator">|</span>   <span class="token number">5.555</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>       <span class="token number">5.6</span> <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">8.760</span> <span class="token operator">|</span>   <span class="token number">8.760</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token boolean">NULL</span> <span class="token operator">|</span>       <span class="token number">8.8</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+---------+------+------+---------+-----------+</span>
<span class="token number">11</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.08</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><ul>
<li>CONCAT – 拼接<br>语法：<code>CONCAT(str1, str2, str3)</code><br>MySQL中使用 CONCAT 函数进行拼接。</li>
<li>LENGTH – 字符串长度<br>语法：<code>LENGTH( 字符串 )</code></li>
<li>LOWER – 小写转换<br>LOWER 函数只能针对英文字母使用，它会将参数中的字符串全都转换为小写。该函数不适用于英文字母以外的场合，不影响原本就是小写的字符。<br>类似的， UPPER 函数用于大写转换。</li>
<li>REPLACE – 字符串的替换<br>语法：<code>REPLACE( 对象字符串，替换前的字符串，替换后的字符串 )</code></li>
<li>SUBSTRING – 字符串的截取<br>语法：<code>SUBSTRING （对象字符串 FROM 截取的起始位置 FOR 截取的字符数）</code><br>使用 SUBSTRING 函数 可以截取出字符串中的一部分字符串。截取的起始位置从字符串最左侧开始计算，索引值起始为1。</li>
<li><strong>（扩展内容）SUBSTRING_INDEX – 字符串按索引截取</strong><br>语法：<code>SUBSTRING_INDEX (原始字符串， 分隔符，n)</code><br>该函数用来获取原始字符串按照分隔符分割后，第 n 个分隔符之前（或之后）的子字符串，支持正向和反向索引，索引起始值分别为 1 和 -1。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------------------------+</span>
<span class="token operator">|</span> SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------------------+</span>
<span class="token operator">|</span> www<span class="token punctuation">.</span>mysql                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------------------------------+</span>
<span class="token operator">|</span> SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------------------+</span>
<span class="token operator">|</span> mysql<span class="token punctuation">.</span>com                                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
获取第1个元素比较容易，获取第2个元素/第n个元素可以采用二次拆分的写法。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------------------------+</span>
<span class="token operator">|</span> SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------------------+</span>
<span class="token operator">|</span> www                                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> SUBSTRING_INDEX<span class="token punctuation">(</span>SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------------------------------------+</span>
<span class="token operator">|</span> SUBSTRING_INDEX<span class="token punctuation">(</span>SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">'www.mysql.com'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------------------------------------+</span>
<span class="token operator">|</span> mysql                                                              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><strong>（扩展内容）REPEAT – 字符串按需重复多次</strong><br>语法：<code>REPEAT(string, number)</code><br>该函数用来对特定字符实现按需重复。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token keyword">REPEAT</span><span class="token punctuation">(</span><span class="token string">'加油！'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">REPEAT</span><span class="token punctuation">(</span><span class="token string">'加油！'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+</span>
<span class="token operator">|</span> 加油！加油！加油！          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="日期函数"><a href="#日期函数" class="headerlink" title="日期函数"></a>日期函数</h3><p>不同DBMS的日期函数语法各有不同，本课程介绍一些被标准 SQL 承认的可以应用于绝大多数 DBMS 的函数。特定DBMS的日期函数查阅文档即可。</p>
<ul>
<li>CURRENT_DATE – 获取当前日期<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">CURRENT_DATE</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> <span class="token keyword">CURRENT_DATE</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>CURRENT_TIME – 当前时间<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">CURRENT_TIME</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> <span class="token keyword">CURRENT_TIME</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> <span class="token number">17</span>:<span class="token number">26</span>:<span class="token number">09</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>CURRENT_TIMESTAMP – 当前日期和时间<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+</span>
<span class="token operator">|</span> <span class="token keyword">CURRENT_TIMESTAMP</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">17</span>:<span class="token number">27</span>:<span class="token number">07</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>EXTRACT – 截取日期元素<br>语法：<code>EXTRACT(日期元素 FROM 日期)</code><br>使用 EXTRACT 函数可以截取出日期数据中的一部分，例如“年”<br>“月”，或者“小时”“秒”等。该函数的返回值并不是日期类型而是数值类型<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">as</span> now<span class="token punctuation">,</span>
EXTRACT<span class="token punctuation">(</span><span class="token keyword">YEAR</span>   <span class="token keyword">FROM</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span><span class="token punctuation">,</span>
EXTRACT<span class="token punctuation">(</span><span class="token keyword">MONTH</span>  <span class="token keyword">FROM</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">month</span><span class="token punctuation">,</span>
EXTRACT<span class="token punctuation">(</span><span class="token keyword">DAY</span>    <span class="token keyword">FROM</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">day</span><span class="token punctuation">,</span>
EXTRACT<span class="token punctuation">(</span><span class="token keyword">HOUR</span>   <span class="token keyword">FROM</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">hour</span><span class="token punctuation">,</span>
EXTRACT<span class="token punctuation">(</span><span class="token keyword">MINUTE</span> <span class="token keyword">FROM</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">MINute</span><span class="token punctuation">,</span>
EXTRACT<span class="token punctuation">(</span><span class="token keyword">SECOND</span> <span class="token keyword">FROM</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">second</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+------+-------+------+------+--------+--------+</span>
<span class="token operator">|</span> now                 <span class="token operator">|</span> <span class="token keyword">year</span> <span class="token operator">|</span> <span class="token keyword">month</span> <span class="token operator">|</span> <span class="token keyword">day</span>  <span class="token operator">|</span> <span class="token keyword">hour</span> <span class="token operator">|</span> <span class="token keyword">MINute</span> <span class="token operator">|</span> <span class="token keyword">second</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+------+-------+------+------+--------+--------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">17</span>:<span class="token number">34</span>:<span class="token number">38</span> <span class="token operator">|</span> <span class="token number">2020</span> <span class="token operator">|</span>     <span class="token number">8</span> <span class="token operator">|</span>    <span class="token number">8</span> <span class="token operator">|</span>   <span class="token number">17</span> <span class="token operator">|</span>     <span class="token number">34</span> <span class="token operator">|</span>     <span class="token number">38</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+------+-------+------+------+--------+--------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="转换函数"><a href="#转换函数" class="headerlink" title="转换函数"></a>转换函数</h3><p>“转换”这个词的含义非常广泛，在 SQL 中主要有两层意思：一是数据类型的转换，简称为类型转换，在英语中称为<code>cast</code>；另一层意思是值的转换。</p>
<ul>
<li>CAST – 类型转换<br>语法：<code>CAST（转换前的值 AS 想要转换的数据类型）</code><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将字符串类型转换为数值类型</span>
<span class="token keyword">SELECT</span> CAST<span class="token punctuation">(</span><span class="token string">'0001'</span> <span class="token keyword">AS</span> SIGNED <span class="token keyword">INTEGER</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> int_col<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+</span>
<span class="token operator">|</span> int_col <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+</span>
<span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment">-- 将字符串类型转换为日期类型</span>
<span class="token keyword">SELECT</span> CAST<span class="token punctuation">(</span><span class="token string">'2009-12-14'</span> <span class="token keyword">AS</span> <span class="token keyword">DATE</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> date_col<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------+</span>
<span class="token operator">|</span> date_col   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+</span>
<span class="token operator">|</span> <span class="token number">2009</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">14</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
需要特别注意的是，当要转换为整型时，需要指定为 SIGNED（有符号） 或者 UNSIGNED（无符号）</li>
<li>COALESCE – 将NULL转换为其他值<br>语法：<code>COALESCE(数据1，数据2，数据3……)</code><br>COALESCE 是 SQL 特有的函数。该函数会返回可变参数 A 中左侧开始第 1个不是NULL的值。参数个数是可变的，因此可以根据需要无限增加。<br>在 SQL 语句中将 NULL 转换为其他值时就会用到转换函数。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> col_1<span class="token punctuation">,</span>
<span class="token keyword">COALESCE</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> col_2<span class="token punctuation">,</span>
<span class="token keyword">COALESCE</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2020-11-01'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> col_3<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------------+</span>
<span class="token operator">|</span> col_1 <span class="token operator">|</span> col_2       <span class="token operator">|</span> col_3      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------------+</span>
<span class="token operator">|</span>    <span class="token number">11</span> <span class="token operator">|</span> hello world <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="谓词"><a href="#谓词" class="headerlink" title="谓词"></a>谓词</h2><h3 id="什么是谓词"><a href="#什么是谓词" class="headerlink" title="什么是谓词"></a>什么是谓词</h3><p>谓词就是返回值为真值的函数。包括<code>TRUE / FALSE / UNKNOWN</code>。<br>谓词主要有以下几个：</p>
<ul>
<li>LIKE</li>
<li>BETWEEN</li>
<li>IS NULL、IS NOT NULL</li>
<li>IN</li>
<li>EXISTS</li>
</ul>
<h3 id="LIKE"><a href="#LIKE" class="headerlink" title="LIKE"></a>LIKE</h3><p>用于字符串的部分一致查询<br>当需要进行字符串的部分一致查询时需要使用该谓词。<br>部分一致大体可以分为前方一致、中间一致和后方一致三种类型。<br>首先我们来创建一张表</p>
<ul>
<li>前方一致：选取出“dddabc”<br>前方一致即作为查询条件的字符串（这里是“ddd”）与查询对象字符串起始部分相同。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> samplelike
<span class="token keyword">WHERE</span> strcol <span class="token operator">LIKE</span> <span class="token string">'ddd%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> strcol <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> dddabc <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
其中的<code>%</code>是代表“零个或多个任意字符串”的特殊符号，本例中代表“以ddd开头的所有字符串”。</li>
<li>中间一致：选取出“abcddd”“dddabc”“abdddc”<br>中间一致即查询对象字符串中含有作为查询条件的字符串，无论该字符串出现在对象字<br>符串的最后还是中间都没有关系。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> samplelike
<span class="token keyword">WHERE</span> strcol <span class="token operator">LIKE</span> <span class="token string">'%ddd%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> strcol <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> abcddd <span class="token operator">|</span>
<span class="token operator">|</span> abdddc <span class="token operator">|</span>
<span class="token operator">|</span> dddabc <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>后方一致：选取出“abcddd“<br>后方一致即作为查询条件的字符串（这里是“ddd”）与查询对象字符串的末尾部分相同。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> samplelike
<span class="token keyword">WHERE</span> strcol <span class="token operator">LIKE</span> <span class="token string">'%ddd'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> strcol <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> abcddd <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
综合如上三种类型的查询可以看出，查询条件最宽松，也就是能够取得最多记录的是<code>中间一致</code>。这是因为它同时包含前方一致和后方一致的查询结果。</li>
<li><code>_</code>下划线匹配任意 1 个字符<br>使用 _（下划线）来代替 %，与 % 不同的是，它代表了“任意 1 个字符”。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> samplelike
<span class="token keyword">WHERE</span> strcol <span class="token operator">LIKE</span> <span class="token string">'abc__'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> strcol <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token operator">|</span> abcdd  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="BETWEEN"><a href="#BETWEEN" class="headerlink" title="BETWEEN"></a>BETWEEN</h3><p>使用 BETWEEN 可以进行范围查询。该谓词与其他谓词或者函数的不同之处在于它使用了3个参数。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 选取销售单价为100～ 1000元的商品</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> sale_price <span class="token operator">BETWEEN</span> <span class="token number">100</span> <span class="token operator">AND</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> T恤          <span class="token operator">|</span>       <span class="token number">1000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 打孔器       <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">|</span> 圆珠笔       <span class="token operator">|</span>        <span class="token number">100</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>BETWEEN 的特点就是结果中会包含 100 和 1000 这两个临界值，也就是闭区间。如果不想让结果中包含临界值，那就必须使用 &lt; 和 &gt;。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> sale_price <span class="token operator">></span> <span class="token number">100</span>
<span class="token operator">AND</span> sale_price <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> 打孔器       <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="IS-NULL、-IS-NOT-NULL"><a href="#IS-NULL、-IS-NOT-NULL" class="headerlink" title="IS NULL、 IS NOT NULL"></a>IS NULL、 IS NOT NULL</h3><p>为了选取出某些值为 NULL 的列的数据，不能使用 =，而只能使用特定的谓词IS NULL。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> purchase_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> purchase_price <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> purchase_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>           <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span> 圆珠笔       <span class="token operator">|</span>           <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与此相反，想要选取NULL以外的数据时，需要使用IS NOT NULL。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> purchase_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> purchase_price <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> purchase_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> T恤          <span class="token operator">|</span>            <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 打孔器       <span class="token operator">|</span>            <span class="token number">320</span> <span class="token operator">|</span>
<span class="token operator">|</span> 运动T恤      <span class="token operator">|</span>           <span class="token number">2800</span> <span class="token operator">|</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>           <span class="token number">2800</span> <span class="token operator">|</span>
<span class="token operator">|</span> 高压锅       <span class="token operator">|</span>           <span class="token number">5000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>            <span class="token number">790</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="IN谓词"><a href="#IN谓词" class="headerlink" title="IN谓词"></a>IN谓词</h3><p>OR的简便用法<br>多个查询条件取并集时可以选择使用<code>or</code>语句。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 通过OR指定多个进货单价进行查询</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> purchase_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> purchase_price <span class="token operator">=</span> <span class="token number">320</span>
<span class="token operator">OR</span> purchase_price <span class="token operator">=</span> <span class="token number">500</span>
<span class="token operator">OR</span> purchase_price <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> purchase_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> T恤          <span class="token operator">|</span>            <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 打孔器       <span class="token operator">|</span>            <span class="token number">320</span> <span class="token operator">|</span>
<span class="token operator">|</span> 高压锅       <span class="token operator">|</span>           <span class="token number">5000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>虽然上述方法没有问题，但还是存在一点不足之处，那就是随着希望选取的对象越来越多， SQL 语句也会越来越长，阅读起来也会越来越困难。这时， 我们就可以使用IN 谓词<br>`IN(值1, 值2, 值3, ……)来替换上述 SQL 语句。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> purchase_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> purchase_price <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> purchase_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> T恤          <span class="token operator">|</span>            <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 打孔器       <span class="token operator">|</span>            <span class="token number">320</span> <span class="token operator">|</span>
<span class="token operator">|</span> 高压锅       <span class="token operator">|</span>           <span class="token number">5000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述语句简洁了很多，可读性大幅提高。<br>反之，希望选取出“进货单价不是 320 元、 500 元、 5000 元”的商品时，可以使用否定形式NOT IN来实现。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> purchase_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> purchase_price <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> purchase_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token operator">|</span> 运动T恤      <span class="token operator">|</span>           <span class="token number">2800</span> <span class="token operator">|</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>           <span class="token number">2800</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>            <span class="token number">790</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是，在使用IN 和 NOT IN 时是无法选取出NULL数据的。<br>实际结果也是如此，上述两组结果中都不包含进货单价为NULL的叉子和圆珠笔。 NULL只能使用 IS NULL 和 IS NOT NULL 来进行判断。</p>
<h4 id="使用子查询作为IN谓词的参数"><a href="#使用子查询作为IN谓词的参数" class="headerlink" title="使用子查询作为IN谓词的参数"></a>使用子查询作为IN谓词的参数</h4><ul>
<li><p>IN和子查询<br>IN 谓词（NOT IN 谓词）具有其他谓词所没有的用法，那就是可以使用子查询作为其参数。子查询就是 SQL内部生成的表，因此也可以说“能够将表作为 IN 的参数”。同理，我们还可以说“能够将视图作为 IN 的参数”。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- step2：取出大阪门店在售商品的销售单价 `sale_price`</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> product_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> product_id
                    <span class="token keyword">FROM</span> shopproduct
                    <span class="token keyword">WHERE</span> shop_id <span class="token operator">=</span> <span class="token string">'000C'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> 运动T恤      <span class="token operator">|</span>       <span class="token number">4000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>       <span class="token number">3000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据第5章学习的知识，子查询是从最内层开始执行的（由内而外），因此，上述语句的子查询执行之后，sql 展开成下面的语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 子查询展开后的结果</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
<span class="token keyword">FROM</span> product
<span class="token keyword">WHERE</span> product_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'0003'</span><span class="token punctuation">,</span> <span class="token string">'0004'</span><span class="token punctuation">,</span> <span class="token string">'0006'</span><span class="token punctuation">,</span> <span class="token string">'0007'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> 运动T恤      <span class="token operator">|</span>       <span class="token number">4000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>       <span class="token number">3000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>既然 in 谓词也能实现，那为什么还要使用子查询呢：<br>①：实际生活中，某个门店的在售商品是不断变化的，使用 in 谓词就需要经常更新 sql 语句，降低了效率，提高了维护成本；<br>②：实际上，某个门店的在售商品可能有成百上千个，手工维护在售商品编号真是个大工程。<br>使用子查询即可保持 sql 语句不变，极大提高了程序的可维护性，这是系统开发中需要重点考虑的内容。</p>
</li>
<li><p>NOT IN和子查询<br>NOT IN 同样支持子查询作为参数，用法和 in 完全一样。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- NOT IN 使用子查询作为参数，取出未在东京门店销售的商品的销售单价</span>
<span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> product_id
                            <span class="token keyword">FROM</span> shopproduct
                           <span class="token keyword">WHERE</span> shop_id <span class="token operator">=</span> <span class="token string">'000A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>       <span class="token number">3000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 高压锅       <span class="token operator">|</span>       <span class="token number">6800</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">|</span> 圆珠笔       <span class="token operator">|</span>        <span class="token number">100</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="EXIST"><a href="#EXIST" class="headerlink" title="EXIST"></a>EXIST</h3><p>EXIST 谓词的用法理解起来有些难度。<br>① EXIST 的使用方法与之前的都不相同<br>② 语法理解起来比较困难<br>③ 实际上即使不使用 EXIST，基本上也都可以使用 IN（或者 NOT IN）来代替</p>
<p>能够熟练使用 EXIST 谓词，就能体会到它极大的便利性。</p>
<ul>
<li>EXIST谓词的使用方法<br>谓词的作用就是 <strong>“判断是否存在满足某种条件的记录”</strong>。<br>如果存在这样的记录就返回真（TRUE），如果不存在就返回假（FALSE）。<br>EXIST（存在）谓词的主语是“记录”。<br>我们继续以 IN和子查询 中的示例，使用 EXIST 选取出大阪门店在售商品的销售单价。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> p
 <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span>
                 <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> sp
                <span class="token keyword">WHERE</span> sp<span class="token punctuation">.</span>shop_id <span class="token operator">=</span> <span class="token string">'000C'</span>
                  <span class="token operator">AND</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> 运动T恤      <span class="token operator">|</span>       <span class="token number">4000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>       <span class="token number">3000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>EXIST的参数<br>之前我们学过的谓词，基本上都是像“列 LIKE 字符串”或者“ 列 BETWEEN 值 1 AND 值 2”这样需要指定 2 个以上的参数，而 EXIST 的左侧并没有任何参数。因为 EXIST 是只有 1 个参数的谓词。 所以，EXIST 只需要在右侧书写 1 个参数，该参数通常都会是一个子查询。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span>
   <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> sp
  <span class="token keyword">WHERE</span> sp<span class="token punctuation">.</span>shop_id <span class="token operator">=</span> <span class="token string">'000C'</span>
    <span class="token operator">AND</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id<span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
上面这样的子查询就是唯一的参数。确切地说，由于通过条件“SP.product_id = P.product_id”将 product 表和 shopproduct表进行了联接，因此作为参数的是关联子查询。 EXIST 通常会使用关联子查询作为参数。</li>
<li>子查询中的SELECT *<br>由于 EXIST 只关心记录是否存在，因此返回哪些列都没有关系。 EXIST 只会判断是否存在满足子查询中 WHERE 子句指定的条件“商店编号（shop_id）为 ‘000C’，商品（product）表和商店<br>商品（shopproduct）表中商品编号（product_id）相同”的记录，只有存在这样的记录时才返回真（TRUE）。<br>因此，使用下面的查询语句，查询结果也不会发生变化。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> p
 <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token comment">-- 这里可以书写适当的常数</span>
                 <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> sp
                <span class="token keyword">WHERE</span> sp<span class="token punctuation">.</span>shop_id <span class="token operator">=</span> <span class="token string">'000C'</span>
                  <span class="token operator">AND</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> 运动T恤      <span class="token operator">|</span>       <span class="token number">4000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>       <span class="token number">3000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>可以把在 EXIST 的子查询中书写 SELECT * 当作 SQL 的一种习惯。</p>
</blockquote>
</li>
<li>使用NOT EXIST替换NOT IN<br>就像 EXIST 可以用来替换 IN 一样， NOT IN 也可以用NOT EXIST来替换。<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name<span class="token punctuation">,</span> sale_price
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> p
 <span class="token keyword">WHERE</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span>
                     <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> sp
                    <span class="token keyword">WHERE</span> sp<span class="token punctuation">.</span>shop_id <span class="token operator">=</span> <span class="token string">'000A'</span>
                      <span class="token operator">AND</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span>       <span class="token number">3000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 高压锅       <span class="token operator">|</span>       <span class="token number">6800</span> <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span>        <span class="token number">500</span> <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span>        <span class="token number">880</span> <span class="token operator">|</span>
<span class="token operator">|</span> 圆珠笔       <span class="token operator">|</span>        <span class="token number">100</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
NOT EXIST 与 EXIST 相反，当“不存在”满足子查询中指定条件的记录时返回真（TRUE）。</li>
</ul>
<h2 id="CASE表达式"><a href="#CASE表达式" class="headerlink" title="CASE表达式"></a>CASE表达式</h2><p>CASE 表达式是函数的一种。是 SQL 中数一数二的重要功能。<br>CASE 表达式是在区分情况时使用的，这种情况的区分在编程中通常称为（条件）分支。<br>CASE表达式的语法分为简单CASE表达式和搜索CASE表达式两种。搜索CASE表达式包含简单CASE表达式的全部功能</p>
<pre class="line-numbers language-none"><code class="language-none">CASE WHEN &lt;求值表达式&gt; THEN &lt;表达式&gt;
     WHEN &lt;求值表达式&gt; THEN &lt;表达式&gt;
     WHEN &lt;求值表达式&gt; THEN &lt;表达式&gt;
     .
     .
     .
ELSE &lt;表达式&gt;
END  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述语句执行时，依次判断 when 表达式是否为真值，是则执行 THEN 后的语句，如果所有的 when 表达式均为假，则执行 ELSE 后的语句。<br>无论多么庞大的 CASE 表达式，最后也只会返回一个值。</p>
<ul>
<li><p><strong>应用场景1：根据不同分支得到不同列值</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  product_name<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'A ： '</span><span class="token punctuation">,</span>product_type<span class="token punctuation">)</span>
        <span class="token keyword">WHEN</span> product_type <span class="token operator">=</span> <span class="token string">'办公用品'</span>  <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'B ： '</span><span class="token punctuation">,</span>product_type<span class="token punctuation">)</span>
        <span class="token keyword">WHEN</span> product_type <span class="token operator">=</span> <span class="token string">'厨房用具'</span>  <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'C ： '</span><span class="token punctuation">,</span>product_type<span class="token punctuation">)</span>
        <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
    <span class="token keyword">END</span> <span class="token keyword">AS</span> abc_product_type
  <span class="token keyword">FROM</span>  product<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+------------------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> abc_product_type <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------------+</span>
<span class="token operator">|</span> T恤          <span class="token operator">|</span> A ： 衣服        <span class="token operator">|</span>
<span class="token operator">|</span> 打孔器       <span class="token operator">|</span> B ： 办公用品    <span class="token operator">|</span>
<span class="token operator">|</span> 运动T恤      <span class="token operator">|</span> A ： 衣服        <span class="token operator">|</span>
<span class="token operator">|</span> 菜刀         <span class="token operator">|</span> C ： 厨房用具    <span class="token operator">|</span>
<span class="token operator">|</span> 高压锅       <span class="token operator">|</span> C ： 厨房用具    <span class="token operator">|</span>
<span class="token operator">|</span> 叉子         <span class="token operator">|</span> C ： 厨房用具    <span class="token operator">|</span>
<span class="token operator">|</span> 擦菜板       <span class="token operator">|</span> C ： 厨房用具    <span class="token operator">|</span>
<span class="token operator">|</span> 圆珠笔       <span class="token operator">|</span> B ： 办公用品    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+------------------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ELSE 子句也可以省略不写，这时会被默认为 ELSE NULL。但为了防止有人漏读，还是希望大家能够显式地写出 ELSE 子句。<br>此外， CASE 表达式最后的“END”是不能省略的，请大家特别注意不要遗漏。忘记书写 END 会发生语法错误，这也是初学时最容易犯的错误。</p>
</li>
<li><p><strong>应用场景2：实现列方向上的聚合</strong><br>通常我们使用如下代码实现行的方向上不同种类的聚合（这里是 sum）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> sum_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type<span class="token punctuation">;</span>  
<span class="token operator">+</span><span class="token comment">--------------+-----------+</span>
<span class="token operator">|</span> product_type <span class="token operator">|</span> sum_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-----------+</span>
<span class="token operator">|</span> 衣服         <span class="token operator">|</span>      <span class="token number">5000</span> <span class="token operator">|</span>
<span class="token operator">|</span> 办公用品      <span class="token operator">|</span>       <span class="token number">600</span> <span class="token operator">|</span>
<span class="token operator">|</span> 厨房用具      <span class="token operator">|</span>     <span class="token number">11180</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-----------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假如要在列的方向上展示不同种类额聚合值，该如何写呢？</p>
<pre class="line-numbers language-none"><code class="language-none">sum_price_clothes | sum_price_kitchen | sum_price_office
------------------+-------------------+-----------------
             5000 |             11180 |              600  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>聚合函数 + CASE WHEN 表达式即可实现该效果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 对按照商品种类计算出的销售单价合计值进行行列转换</span>
<span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span> <span class="token keyword">THEN</span> sale_price <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> sum_price_clothes<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> product_type <span class="token operator">=</span> <span class="token string">'厨房用具'</span> <span class="token keyword">THEN</span> sale_price <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> sum_price_kitchen<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> product_type <span class="token operator">=</span> <span class="token string">'办公用品'</span> <span class="token keyword">THEN</span> sale_price <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> sum_price_office
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+------------------+</span>
<span class="token operator">|</span> sum_price_clothes <span class="token operator">|</span> sum_price_kitchen <span class="token operator">|</span> sum_price_office <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+------------------+</span>
<span class="token operator">|</span>              <span class="token number">5000</span> <span class="token operator">|</span>             <span class="token number">11180</span> <span class="token operator">|</span>              <span class="token number">600</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p><strong>应用场景3：实现行转列</strong><br>假设有如下图表的结构</p>
<img src='/medias/image/2022-12-08-12-03-33.png' width="40%">
计划得到如下的图表结构
<img src='/medias/image/2022-12-08-12-03-44.png' width="50%">
聚合函数 + CASE WHEN 表达式即可实现该转换</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- CASE WHEN 实现数字列 score 行转列</span>
<span class="token keyword">SELECT</span> name<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> subject <span class="token operator">=</span> <span class="token string">'语文'</span> <span class="token keyword">THEN</span> score <span class="token keyword">ELSE</span> <span class="token boolean">null</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> chinese<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> subject <span class="token operator">=</span> <span class="token string">'数学'</span> <span class="token keyword">THEN</span> score <span class="token keyword">ELSE</span> <span class="token boolean">null</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> subject <span class="token operator">=</span> <span class="token string">'外语'</span> <span class="token keyword">THEN</span> score <span class="token keyword">ELSE</span> <span class="token boolean">null</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> english
  <span class="token keyword">FROM</span> score
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> name<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+---------+------+---------+</span>
<span class="token operator">|</span> name <span class="token operator">|</span> chinese <span class="token operator">|</span> math <span class="token operator">|</span> english <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+------+---------+</span>
<span class="token operator">|</span> 张三 <span class="token operator">|</span>      <span class="token number">93</span> <span class="token operator">|</span>   <span class="token number">88</span> <span class="token operator">|</span>      <span class="token number">91</span> <span class="token operator">|</span>
<span class="token operator">|</span> 李四 <span class="token operator">|</span>      <span class="token number">87</span> <span class="token operator">|</span>   <span class="token number">90</span> <span class="token operator">|</span>      <span class="token number">77</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+------+---------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码实现了数字列 score 的行转列，也可以实现文本列 subject 的行转列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- CASE WHEN 实现文本列 subject 行转列</span>
<span class="token keyword">SELECT</span> name<span class="token punctuation">,</span>
       <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> subject <span class="token operator">=</span> <span class="token string">'语文'</span> <span class="token keyword">THEN</span> subject <span class="token keyword">ELSE</span> <span class="token boolean">null</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> chinese<span class="token punctuation">,</span>
       <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> subject <span class="token operator">=</span> <span class="token string">'数学'</span> <span class="token keyword">THEN</span> subject <span class="token keyword">ELSE</span> <span class="token boolean">null</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span>
       <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> subject <span class="token operator">=</span> <span class="token string">'外语'</span> <span class="token keyword">THEN</span> subject <span class="token keyword">ELSE</span> <span class="token boolean">null</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> english
<span class="token keyword">FROM</span> score
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> name<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+---------+------+---------+</span>
<span class="token operator">|</span> name <span class="token operator">|</span> chinese <span class="token operator">|</span> math <span class="token operator">|</span> english <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+------+---------+</span>
<span class="token operator">|</span> 张三 <span class="token operator">|</span> 语文    <span class="token operator">|</span> 数学 <span class="token operator">|</span> 外语    <span class="token operator">|</span>
<span class="token operator">|</span> 李四 <span class="token operator">|</span> 语文    <span class="token operator">|</span> 数学 <span class="token operator">|</span> 外语    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+------+---------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>总结：</p>
<ul>
<li>当待转换列为数字时，可以使用<code>SUM AVG MAX MIN</code>等聚合函数；</li>
<li>当待转换列为文本时，可以使用<code>MAX MIN</code>等聚合函数</li>
</ul>
<h1 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h1><p><code>集合</code>在数学领域表示“各种各样的事物的总和”, 在数据库领域表示记录的集合. 具体来说,表、视图和查询的执行结果都是记录的集合, 其中的元素为表或者查询结果中的每一行。<br>在标准 SQL 中, 分别对检索结果使用 <code>UNION</code>, <code>INTERSECT,</code> <code>EXCEPT</code> 来将检索结果进行并,交和差运算, 像<code>UNION</code>,<code>INTERSECT</code>, <code>EXCEPT</code>这种用来进行集合运算的运算符称为集合运算符。<br>在数据库中, 所有的表–以及查询结果–都可以视为集合, 因此也可以把表视为集合进行上述集合运算, 在很多时候, 这种抽象非常有助于对复杂查询问题给出一个可行的思路。</p>
<h2 id="加减法"><a href="#加减法" class="headerlink" title="加减法"></a>加减法</h2><h3 id="UNION"><a href="#UNION" class="headerlink" title="UNION"></a>UNION</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name
  <span class="token keyword">FROM</span> product
 <span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name
  <span class="token keyword">FROM</span> product2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述结果包含了两张表中的全部商品，这就是集合中的并集运算<br> <strong>UNION 等集合运算符通常都会除去重复的记录</strong>。<br>上述查询是对不同的两张表进行求并集运算. 对于同一张表, 实际上也是可以进行求并集的。</p>
<p>假设连锁店想要增加成本利润率超过 50%或者售价低于 800 的货物的存货量, 请使用 UNION 对分别满足上述两个条件的商品的查询结果求并集：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 参考答案:</span>
<span class="token keyword">SELECT</span>  product_id<span class="token punctuation">,</span>product_name<span class="token punctuation">,</span>product_type
       <span class="token punctuation">,</span>sale_price<span class="token punctuation">,</span>purchase_price
  <span class="token keyword">FROM</span> product 
 <span class="token keyword">WHERE</span> sale_price<span class="token operator">&lt;</span><span class="token number">800</span>
  
 <span class="token keyword">UNION</span>
 
<span class="token keyword">SELECT</span>  product_id<span class="token punctuation">,</span>product_name<span class="token punctuation">,</span>product_type
       <span class="token punctuation">,</span>sale_price<span class="token punctuation">,</span>purchase_price
  <span class="token keyword">FROM</span> product 
 <span class="token keyword">WHERE</span> sale_price<span class="token operator">></span><span class="token number">1.5</span><span class="token operator">*</span>purchase_price<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="UNION-OR"><a href="#UNION-OR" class="headerlink" title="UNION OR"></a>UNION OR</h4><p>思考: 如果不使用 UNION 该怎么写查询语句?</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 参考答案:</span>
<span class="token keyword">SELECT</span>  product_id<span class="token punctuation">,</span>product_name<span class="token punctuation">,</span>product_type
       <span class="token punctuation">,</span>sale_price<span class="token punctuation">,</span>purchase_price
  <span class="token keyword">FROM</span> product 
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">&lt;</span> <span class="token number">800</span> 
    <span class="token operator">OR</span> sale_price <span class="token operator">></span> <span class="token number">1.5</span> <span class="token operator">*</span> purchase_price<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于上边的练习题, 如果你已经正确地写出来查询, 你会发现, 使用 UNION 对两个查询结果取并集, 和在一个查询中使用 WHERE 子句, 然后使用 OR 谓词连接两个查询条件, 能够得到相同的结果。<br>那么是不是就没必要引入 UNION 了呢? 当然不是这样的. 确实, 对于同一个表的两个不同的筛选结果集, 使用 UNION 对两个结果集取并集, 和把两个子查询的筛选条件用  OR 谓词连接, 会得到相同的结果, 但倘若要将两个不同的表中的结果合并在一起, 就不得不使用 UNION 了。<br>而且, 即便是对于同一张表, 有时也会出于查询效率方面的因素来使用 UNION。<br>分别使用 UNION 或者 OR 谓词,找出成本利润率不足 30%或成本利润率未知的商品。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用 OR 谓词</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product 
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">/</span> purchase_price <span class="token operator">&lt;</span> <span class="token number">1.3</span> 
    <span class="token operator">OR</span> sale_price <span class="token operator">/</span> purchase_price <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用 UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product 
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">/</span> purchase_price <span class="token operator">&lt;</span> <span class="token number">1.3</span>
 <span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product 
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">/</span> purchase_price <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="UNION-ALL"><a href="#UNION-ALL" class="headerlink" title="UNION ALL"></a>UNION ALL</h4><p>UNION 会对两个查询的结果集进行合并和去重, 这种去重不仅会去掉两个结果集相互重复的, 还会去掉一个结果集中的重复行. 但在实践中有时候需要需要不去重的并集, 在 UNION 的结果中保留重复行的语法其实非常简单,只需要在 UNION 后面添加 ALL 关键字就可以了。<br>例如,  想要知道 product 和 product2 中所包含的商品种类及每种商品的数量, 第一步,就需要将两个表的商品种类字段选出来, 然后使用 UNION ALL 进行不去重地合并. 接下来再对两个表的结果按 product_type 字段分组计数。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 保留重复行</span>
<span class="token keyword">SELECT</span> product_type
  <span class="token keyword">FROM</span> product
 <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> product_type
  <span class="token keyword">FROM</span> product2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="隐式数据类型转换"><a href="#隐式数据类型转换" class="headerlink" title="隐式数据类型转换"></a>隐式数据类型转换</h4><p>通常来说, 我们会把类型完全一致, 并且代表相同属性的列使用 UNION 合并到一起显示, 但有时候, 即使数据类型不完全相同, 也会通过隐式类型转换来将两个类型不同的列放在一列里显示, 例如字符串和数值类型: </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> <span class="token string">'1'</span>
  <span class="token keyword">FROM</span> product
 <span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span>sale_price
  <span class="token keyword">FROM</span> product2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述查询能够正确执行<br><strong>需要注意的是 hive中进行join关联时，关联列要避免使用隐式数据类型转换，否则容易导致数据倾斜</strong></p>
<h3 id="交集"><a href="#交集" class="headerlink" title="交集"></a>交集</h3><p>集合的交, 就是两个集合的公共部分, 由于集合元素的互异性, 集合的交只需通过文氏图就可以很直观地看到它的意义。<br>虽然集合的交运算在SQL标准中已经出现多年了, 然而很遗憾的是, 截止到 MySQL 8.0 版本, MySQL 仍然不支持 INTERSECT 操作。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name
  <span class="token keyword">FROM</span> product
<span class="token keyword">INTERSECT</span>
<span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> product_name
  <span class="token keyword">FROM</span> product2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>错误代码：1064<br>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ‘SELECT product_id, product_name<br>FROM product2</p>
</blockquote>
<p>此时需要用 inner join 来求得交集</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> p1<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> p1<span class="token punctuation">.</span>product_name
  <span class="token keyword">FROM</span> product p1
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product2 p2
<span class="token keyword">ON</span> p1<span class="token punctuation">.</span>product_id<span class="token operator">=</span>p2<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="INTERSECT-AND"><a href="#INTERSECT-AND" class="headerlink" title="INTERSECT AND"></a>INTERSECT AND</h4><p>对于同一个表的两个查询结果而言, 他们的交INTERSECT实际上可以等价地将两个查询的检索条件用AND谓词连接来实现。<br>使用AND谓词查找product表中利润率高于50%,并且售价低于1500的商品：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">></span> <span class="token number">1.5</span> <span class="token operator">*</span> purchase_price 
   <span class="token operator">AND</span> sale_price <span class="token operator">&lt;</span> <span class="token number">1500</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="差集-补集与表的减法"><a href="#差集-补集与表的减法" class="headerlink" title="差集,补集与表的减法"></a>差集,补集与表的减法</h3><p>求集合差集的减法运算和实数的减法运算有些不同, 当使用一个集合A减去另一个集合B的时候,对于只存在于集合B而不存在于集合A的元素, 采取直接忽略的策略,因此集合A和B做减法只是将集合A中也同时属于集合B的元素减掉。</p>
<h4 id="EXCEPT"><a href="#EXCEPT" class="headerlink" title="EXCEPT"></a>EXCEPT</h4><p>MySQL 8.0 还不支持 表的减法运算符 EXCEPT. 不过, 借助NOT IN谓词, 我们同样可以实现表的减法。<br>找出只存在于product表但不存在于product2表的商品：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用 NOT IN 子句的实现方法</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> product_id 
                            <span class="token keyword">FROM</span> product2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="EXCEPT与NOT"><a href="#EXCEPT与NOT" class="headerlink" title="EXCEPT与NOT"></a>EXCEPT与NOT</h4><p>通过上述练习题的MySQL解法, 我们发现, 使用 NOT IN 谓词, 基本上可以实现和SQL标准语法中的EXCEPT运算相同的效果。<br>使用NOT谓词进行集合的减法运算, 求出 product 表中, 售价高于2000、成本利润率不低于 30% 的商品, 结果应该如下表所示：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> sale_price <span class="token operator">></span> <span class="token number">2000</span> 
   <span class="token operator">AND</span> product_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> product_id 
                            <span class="token keyword">FROM</span> product 
                           <span class="token keyword">WHERE</span> sale_price <span class="token operator">&lt;</span> <span class="token number">1.3</span><span class="token operator">*</span>purchase_price<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="对称差"><a href="#对称差" class="headerlink" title="对称差"></a>对称差</h4><p>两个集合A,B的对称差是指那些仅属于A或仅属于B的元素构成的集合. 对称差也是个非常基础的运算, 例如, 两个集合的交就可以看作是两个集合的并去掉两个集合的对称差.上述方法在其他数据库里也可以用来简单地实现表或查询结果的对称差运算: 首先使用UNION求两个表的并集, 然后使用INTERSECT求两个表的交集, 然后用并集减去交集, 就得到了对称差。</p>
<p>但由于在MySQL 8.0 里, 由于两个表或查询结果的并不能直接求出来, 因此并不适合使用上述思路来求对称差. 好在还有差集运算可以使用. 从直观上就能看出来, 两个集合的对称差等于 A-B并上B-A, 因此实践中可以用这个思路来求对称差。</p>
<p>使用product表和product2表的对称差来查询哪些商品只在其中一张表, 结果类似于:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用 NOT IN 实现两个表的差集</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product
 <span class="token keyword">WHERE</span> product_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> product_id <span class="token keyword">FROM</span> product2<span class="token punctuation">)</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
  <span class="token keyword">FROM</span> product2
 <span class="token keyword">WHERE</span> product_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> product_id <span class="token keyword">FROM</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="JOIN"><a href="#JOIN" class="headerlink" title="JOIN"></a>JOIN</h2><p>UNION和INTERSECT等集合运算的特征就是以行方向为单位进行操作. 通俗地说, 就是进行这些集合运算时, 会导致记录行数的增减. 使用 UNION 会增加记录行数,而使用 INTERSECT 或者 EXCEPT 会减少记录行数。<br>但这些运算不能改变列的变化, 虽然使用函数或者 CASE表达式等列运算, 可以增加列的数量, 但仍然只能从一张表中提供的基础信息列中获得一些”引申列”, 本质上并不能提供更多的信息. 如果想要从多个表获取信息, 例如, 如果我们想要找出某个商店里的衣服类商品的名称,数量及价格等信息, 则必须分别从 shopproduct 表和 product 表获取信息。<br><img src='/medias/image/2022-12-08-13-18-59.png' width="80%"></p>
<p>连结(JOIN)就是使用某种关联条件(一般是使用相等判断谓词”=”), 将其他表中的列添加过来, 进行“添加列”的集合运算. 可以说,连结是 SQL 查询的核心操作, 掌握了连结, 能够从两张甚至多张表中获取列, 能够将过去使用关联子查询等过于复杂的查询简化为更加易读的形式, 以及进行一些更加复杂的查询。</p>
<h3 id="内连结-INNER-JOIN"><a href="#内连结-INNER-JOIN" class="headerlink" title="内连结 INNER JOIN"></a>内连结 INNER JOIN</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 内连结</span>
<span class="token keyword">FROM</span> <span class="token operator">&lt;</span>tb_1<span class="token operator">></span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token operator">&lt;</span>tb_2<span class="token operator">></span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>condition<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>找出商店里的衣服类商品的商品名称,商品价格,商品种类,商品数量信息。</p>
<p>我们把上述问题进行分解:</p>
<p>首先, 找出每个商店的商店编号, 商店名称, 商品编号, 商品名称,  商品类别,  商品售价,商品数量信息。</p>
<p>按照内连结的语法, 在 FROM 子句中使用 INNER JOIN 将两张表连接起来, 并为 ON 子句指定连结条件为 shopproduct.product_id=product.product_id, 就得到了如下的查询语句:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_type
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity
  <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上述查询中, 我们分别为两张表指定了简单的别名, 这种操作在使用连结时是非常常见的, 通过别名会让我们在编写查询时少打很多字, 并且更重要的是, 会让查询语句看起来更加简洁。<br>观察查询结果, 我们看到,这个结果里的列已经包含了所有我们需要的信息。</p>
<p>关于内连结,需要注意以下三点:<br><strong>要点一: 进行连结时需要在 FROM 子句中使用多张表.</strong><br>之前的 FROM 子句中只有一张表, 而这次我们同时使用了 shopproduct 和 product 两张表,使用关键字 INNER JOIN 就可以将两张表连结在一起了:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>要点二:必须使用 ON 子句来指定连结条件.</strong><br>在进行内连结时 ON 子句是必不可少的(大家可以试试去掉上述查询的 ON 子句后会有什么结果)。<br>ON 子句是专门用来指定连结条件的, 我们在上述查询的 ON 之后指定两张表连结所使用的列以及比较条件, 基本上, 它能起到与 WHERE 相同的筛选作用, 我们会在本章的结尾部分进一步探讨这个话题。<br><strong>要点三: SELECT 子句中的列最好按照 表名.列名 的格式来使用。</strong><br>当两张表的列除了用于关联的列之外, 没有名称相同的列的时候, 也可以不写表名, 但表名使得我们能够在今后的任何时间阅读查询代码的时候, 都能马上看出每一列来自于哪张表, 能够节省我们很多时间。<br>但是, 如果两张表有其他名称相同的列, 则必须使用上述格式来选择列名, 否则查询语句会报错。</p>
<h4 id="结合-WHERE"><a href="#结合-WHERE" class="headerlink" title="结合 WHERE"></a>结合 WHERE</h4><p>如果需要在使用内连结的时候同时使用 WHERE 子句对检索结果进行筛选, 则需要把 WHERE 子句写在 ON 子句的后边。<br>第一种增加 WEHRE 子句的方式, 就是把上述查询作为子查询, 用括号封装起来, 然后在外层查询增加筛选条件。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
  <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token comment">-- 第一步查询的结果</span>
        <span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
               <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
               <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
               <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
               <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_type
               <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
               <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity
          <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP
         <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P
            <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> STEP1
 <span class="token keyword">WHERE</span> shop_name <span class="token operator">=</span> <span class="token string">'东京'</span>
   <span class="token operator">AND</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还记得我们学习子查询时的认识吗? 子查询的结果其实也是一张表,只不过是一张虚拟的表, 它并不真实存在于数据库中, 只是数据库中其他表经过筛选,聚合等查询操作后得到的一个”视图”。<br>这种写法能很清晰地分辨出每一个操作步骤, 在我们还不十分熟悉 SQL 查询每一个子句的执行顺序的时候可以帮到我们。</p>
<p>但实际上, 如果我们熟知 WHERE 子句将在 FROM 子句之后执行, 也就是说, 在做完 INNER JOIN … ON 得到一个新表后, 才会执行 WHERE 子句, 那么就得到标准的写法:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_type
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity
  <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id
 <span class="token keyword">WHERE</span> SP<span class="token punctuation">.</span>shop_name <span class="token operator">=</span> <span class="token string">'东京'</span>
   <span class="token operator">AND</span> P<span class="token punctuation">.</span>product_type <span class="token operator">=</span> <span class="token string">'衣服'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们首先给出上述查询的执行顺序:<br>FROM 子句-&gt;WHERE 子句-&gt;SELECT 子句<br>也就是说, 两张表是先按照连结列进行了连结, 得到了一张新表, 然后 WHERE 子句对这张新表的行按照两个条件进行了筛选,  最后, SELECT 子句选出了那些我们需要的列。<br>此外, 一种不是很常见的做法是,还可以将 WHERE 子句中的条件直接添加在 ON 子句中, 这时候 ON 子句后最好用括号将连结条件和筛选条件括起来。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_type
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity
  <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P
    <span class="token keyword">ON</span> <span class="token punctuation">(</span>SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id
   <span class="token operator">AND</span> SP<span class="token punctuation">.</span>shop_name <span class="token operator">=</span> <span class="token string">'东京'</span>
   <span class="token operator">AND</span> P<span class="token punctuation">.</span>product_type <span class="token operator">=</span> <span class="token string">'衣服'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但上述这种把筛选条件和连结条件都放在 ON 子句的写法, 不是太容易阅读, 不建议大家使用。<br>另外, 先连结再筛选的标准写法的执行顺序是, 两张完整的表做了连结之后再做筛选,如果要连结多张表, 或者需要做的筛选比较复杂时, 在写 SQL 查询时会感觉比较吃力. 在结合 WHERE 子句使用内连结的时候, 我们也可以更改任务顺序, 并采用任务分解的方法,先分别在两个表使用 WHERE 进行筛选,然后把上述两个子查询连结起来。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_type
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity
  <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token comment">-- 子查询 1:从 shopproduct 表筛选出东京商店的信息</span>
        <span class="token keyword">SELECT</span> <span class="token operator">*</span>
          <span class="token keyword">FROM</span> shopproduct
         <span class="token keyword">WHERE</span> shop_name <span class="token operator">=</span> <span class="token string">'东京'</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> SP
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token comment">-- 子查询 2:从 product 表筛选出衣服类商品的信息</span>
   <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span>
      <span class="token keyword">FROM</span> product
     <span class="token keyword">WHERE</span> product_type <span class="token operator">=</span> <span class="token string">'衣服'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> P
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先分别在两张表里做筛选, 把复杂的筛选条件按表分拆, 然后把筛选结果(作为表)连接起来, 避免了写复杂的筛选条件, 因此这种看似复杂的写法, 实际上整体的逻辑反而非常清晰. 在写查询的过程中, 首先要按照最便于自己理解的方式来写, 先把问题解决了, 再思考优化的问题。</p>
<h4 id="结合-GROUP-BY"><a href="#结合-GROUP-BY" class="headerlink" title="结合 GROUP BY"></a>结合 GROUP BY</h4><p>结合 GROUP BY 子句使用内连结, 需要根据分组列位于哪个表区别对待。<br>最简单的情形, 是在内连结之前就使用 GROUP BY 子句.<br>但是如果分组列和被聚合的列不在同一张表, 且二者都未被用于连结两张表, 则只能先连结, 再聚合。</p>
<p>每个商店中, 售价最高的商品的售价分别是多少?</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 参考答案</span>
<span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
      <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
      <span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>P<span class="token punctuation">.</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> max_price
  <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> SP<span class="token punctuation">.</span>shop_id<span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="自连结-SELF-JOIN"><a href="#自连结-SELF-JOIN" class="headerlink" title="自连结(SELF JOIN)"></a>自连结(SELF JOIN)</h4><p>之前的内连结,  连结的都是不一样的两个表。但实际上一张表也可以与自身作连结, 这种连接称之为自连结. 需要注意, 自连结并不是区分于内连结和外连结的第三种连结, 自连结可以是外连结也可以是内连结, 它是不同于内连结外连结的另一个连结的分类方法。</p>
<h4 id="内连结与关联子查询"><a href="#内连结与关联子查询" class="headerlink" title="内连结与关联子查询"></a>内连结与关联子查询</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  P1<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P1<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P1<span class="token punctuation">.</span>product_type
       <span class="token punctuation">,</span>P1<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>P2<span class="token punctuation">.</span>avg_price
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P1
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
   <span class="token punctuation">(</span><span class="token keyword">SELECT</span> product_type<span class="token punctuation">,</span><span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_price 
      <span class="token keyword">FROM</span> product 
     <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type<span class="token punctuation">)</span> <span class="token keyword">AS</span> P2 
    <span class="token keyword">ON</span> P1<span class="token punctuation">.</span>product_type <span class="token operator">=</span> P2<span class="token punctuation">.</span>product_type
 <span class="token keyword">WHERE</span> P1<span class="token punctuation">.</span>sale_price <span class="token operator">></span> P2<span class="token punctuation">.</span>avg_price<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>仅仅从代码量上来看, 上述方法似乎比关联子查询更加复杂, 但这并不意味着这些代码更难理解. 通过上述分析, 很容易发现上述代码的逻辑实际上更符合我们的思路, 因此尽管看起来复杂, 但思路实际上更加清晰。</p>
<h4 id="自然连结-NATURAL-JOIN"><a href="#自然连结-NATURAL-JOIN" class="headerlink" title="自然连结(NATURAL JOIN)"></a>自然连结(NATURAL JOIN)</h4><p>自然连结并不是区别于内连结和外连结的第三种连结, 它其实是内连结的一种特例–当两个表进行自然连结时, 会按照两个表中都包含的列名来进行等值内连结, 此时无需使用 ON 来指定连接条件。   </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>  <span class="token keyword">FROM</span> shopproduct <span class="token keyword">NATURAL</span> <span class="token keyword">JOIN</span> product<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上述查询得到的结果, 会把两个表的公共列(这里是 product_id, 可以有多个公共列)放在第一列, 然后按照两个表的顺序和表中列的顺序, 将两个表中的其他列都罗列出来。<br>与上述自然连结等价的内连结：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 参考答案</span>
<span class="token keyword">SELECT</span>  SP<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_id<span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name<span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name<span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_type<span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>purchase_price<span class="token punctuation">,</span>P<span class="token punctuation">.</span>regist_date  
  <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP 
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P 
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用自然连结还可以求出两张表或子查询的公共部分：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">NATURAL</span> <span class="token keyword">JOIN</span> product2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="使用连结求交集"><a href="#使用连结求交集" class="headerlink" title="使用连结求交集"></a>使用连结求交集</h4><p>使用内连结求 product 表和 product2 表的交集。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> P1<span class="token punctuation">.</span><span class="token operator">*</span>
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P1
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product2 <span class="token keyword">AS</span> P2
    <span class="token keyword">ON</span> <span class="token punctuation">(</span>P1<span class="token punctuation">.</span>product_id  <span class="token operator">=</span> P2<span class="token punctuation">.</span>product_id
   <span class="token operator">AND</span> P1<span class="token punctuation">.</span>product_name <span class="token operator">=</span> P2<span class="token punctuation">.</span>product_name
   <span class="token operator">AND</span> P1<span class="token punctuation">.</span>product_type <span class="token operator">=</span> P2<span class="token punctuation">.</span>product_type
   <span class="token operator">AND</span> P1<span class="token punctuation">.</span>sale_price   <span class="token operator">=</span> P2<span class="token punctuation">.</span>sale_price
   <span class="token operator">AND</span> P1<span class="token punctuation">.</span>regist_date  <span class="token operator">=</span> P2<span class="token punctuation">.</span>regist_date<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> P1<span class="token punctuation">.</span><span class="token operator">*</span>
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P1
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> product2 <span class="token keyword">AS</span> P2
    <span class="token keyword">ON</span> P1<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P2<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="外连结-OUTER-JOIN"><a href="#外连结-OUTER-JOIN" class="headerlink" title="外连结 OUTER JOIN"></a>外连结 OUTER JOIN</h3><p>内连结会丢弃两张表中不满足 ON 条件的行,和内连结相对的就是外连结. 外连结会根据外连结的种类有选择地保留无法匹配到的行。<br>按照保留的行位于哪张表,外连结有三种形式: 左连结, 右连结和全外连结。<br>左连结会保存左表中无法按照 ON 子句匹配到的行, 此时对应右表的行均为缺失值; 右连结则会保存右表中无法按照 ON 子句匹配到的行, 此时对应左表的行均为缺失值;  而全外连结则会同时保存两个表中无法按照 ON子句匹配到的行, 相应的另一张表中的行用缺失值填充。<br>三种外连结的对应语法分别为:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 左连结     </span>
<span class="token keyword">FROM</span> <span class="token operator">&lt;</span>tb_1<span class="token operator">></span> <span class="token keyword">LEFT</span>  <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> <span class="token operator">&lt;</span>tb_2<span class="token operator">></span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>condition<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token comment">-- 右连结     </span>
<span class="token keyword">FROM</span> <span class="token operator">&lt;</span>tb_1<span class="token operator">></span> <span class="token keyword">RIGHT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> <span class="token operator">&lt;</span>tb_2<span class="token operator">></span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>condition<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">></span>
<span class="token comment">-- 全外连结</span>
<span class="token keyword">FROM</span> <span class="token operator">&lt;</span>tb_1<span class="token operator">></span> <span class="token keyword">FULL</span>  <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> <span class="token operator">&lt;</span>tb_2<span class="token operator">></span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>condition<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="左连结与右连结"><a href="#左连结与右连结" class="headerlink" title="左连结与右连结"></a>左连结与右连结</h4><p>由于连结时可以交换左表和右表的位置, 因此左连结和右连结并没有本质区别.接下来我们先以左连结为例进行学习. 所有的内容在调换两个表的前后位置, 并将左连结改为右连结之后, 都能得到相同的结果.  稍后再介绍全外连结的概念。</p>
<h4 id="使用左连结从两个表获取信息"><a href="#使用左连结从两个表获取信息" class="headerlink" title="使用左连结从两个表获取信息"></a>使用左连结从两个表获取信息</h4><p>使用左连结的代码如下:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P
  <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> shopproduct <span class="token keyword">AS</span> SP
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>● 外连结要点 1: 选取出单张表中全部的信息</strong><br>与内连结的结果相比,不同点显而易见,那就是结果的行数不一样.内连结的结果中有 13 条记录,而外连结的结果中有 15 条记录,增加的 2 条记录到底是什么呢?这正是外连结的关键点. 多出的 2 条记录是高压锅和圆珠笔,这 2 条记录在 shopproduct 表中并不存在,也就是说,这 2 种商品在任何商店中都没有销售.由于内连结只能选取出同时存在于两张表中的数据,因此只在 product 表中存在的 2 种商品并没有出现在结果之中.相反,对于外连结来说,只要数据存在于某一张表当中,就能够读取出来.在实际的业务中,例如想要生成固定行数的单据时,就需要使用外连结.如果使用内连结的话,根据 SELECT 语句执行时商店库存状况的不同,结果的行数也会发生改变,生成的单据的版式也会受到影响,而使用外连结能够得到固定行数的结果.虽说如此,那些表中不存在的信息我们还是无法得到,结果中高压锅和圆珠笔的商店编号和商店名称都是 NULL （具体信息大家都不知道,真是无可奈何）.外连结名称的由来也跟 NULL 有关,即“结果中包含原表中不存在（在原表之外）的信息”.相反,只包含表内信息的连结也就被称为内连结了。</p>
<p><strong>● 外连结要点 2：使用 LEFT、RIGHT 来指定主表.</strong><br>外连结还有一点非常重要,那就是要把哪张表作为主表.最终的结果中会包含主表内所有的数据.指定主表的关键字是 LEFT 和 RIGHT.顾名思义,使用 LEFT 时 FROM 子句中写在左侧的表是主表,使用 RIGHT 时右侧的表是主表.代码清单 7-11 中使用了 RIGHT ,因此,右侧的表,也就是 product 表是主表.我们还可以像代码清单 7-12 这样进行改写,意思完全相同.这样你可能会困惑，到底应该使用 LEFT 还是 RIGHT？其实它们的功能没有任何区别,使用哪一个都可以.通常使用 LEFT 的情况会多一些,但也并没有非使用这个不可的理由,使用 RIGHT 也没有问题。</p>
<p>通过交换两个表的顺序, 同时将 LEFT 更换为 RIGHT(如果原先是 RIGHT,则更换为 LEFT), 两种方式会到完全相同的结果。</p>
<h4 id="结合-WHERE-左连结"><a href="#结合-WHERE-左连结" class="headerlink" title="结合 WHERE 左连结"></a>结合 WHERE 左连结</h4><p>使用外连结从shopproduct表和product表中找出那些在某个商店库存少于50的商品及对应的商店.希望得到如下结果。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> P<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P
  <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> shopproduct <span class="token keyword">AS</span> SP
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id
 <span class="token keyword">WHERE</span> quantity<span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> P<span class="token punctuation">.</span>product_id
      <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
      <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_id
      <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
      <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>quantity 
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P
  <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span><span class="token comment">-- 先筛选quantity&lt;50的商品</span>
   <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span>
      <span class="token keyword">FROM</span> shopproduct
     <span class="token keyword">WHERE</span> quantity <span class="token operator">&lt;</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> SP
    <span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="全外连结"><a href="#全外连结" class="headerlink" title="全外连结"></a>全外连结</h4><p>有了对左连结和右连结的了解, 就不难理解全外连结的含义了. 全外连结本质上就是对左表和右表的所有行都予以保留, 能用 ON 关联到的就把左表和右表的内容在一行内显示, 不能被关联到的就分别显示, 然后把多余的列用缺失值填充。<br>遗憾的是, MySQL8.0 目前还不支持全外连结, 不过我们可以对左连结和右连结的结果进行 UNION 来实现全外连结。</p>
<h3 id="多表连结"><a href="#多表连结" class="headerlink" title="多表连结"></a>多表连结</h3><p>通常连结只涉及 2 张表,但有时也会出现必须同时连结 3 张以上的表的情况, 原则上连结表的数量并没有限制。</p>
<h4 id="多表进行内连结"><a href="#多表进行内连结" class="headerlink" title="多表进行内连结"></a>多表进行内连结</h4><p>接下来, 我们根据上表及 shopproduct 表和 product 表, 使用内连接找出每个商店都有那些商品, 每种商品的库存总量分别是多少。</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">SELECT SP.shop_id
       ,SP.shop_name
       ,SP.product_id
       ,P.product_name
       ,P.sale_price
       ,IP.inventory_quantity
  FROM shopproduct AS SP
 INNER JOIN product AS P
    ON SP.product_id &#x3D; P.product_id
 INNER JOIN Inventoryproduct AS IP
    ON SP.product_id &#x3D; IP.product_id
 WHERE IP.inventory_id &#x3D; &#39;P001&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="多表进行外连结"><a href="#多表进行外连结" class="headerlink" title="多表进行外连结"></a>多表进行外连结</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> P<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>IP<span class="token punctuation">.</span>inventory_quantity
  <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P
  <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> shopproduct <span class="token keyword">AS</span> SP
<span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> Inventoryproduct <span class="token keyword">AS</span> IP
<span class="token keyword">ON</span> SP<span class="token punctuation">.</span>product_id <span class="token operator">=</span> IP<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ON子句进阶–非等值连结"><a href="#ON子句进阶–非等值连结" class="headerlink" title="ON子句进阶–非等值连结"></a>ON子句进阶–非等值连结</h3><p>在刚开始介绍连结的时候, 书上提到过, 除了使用相等判断的等值连结, 也可以使用比较运算符来进行连接. 实际上, 包括比较运算符(&lt;,&lt;=,&gt;,&gt;=, BETWEEN)和谓词运算(LIKE, IN, NOT 等等)在内的所有的逻辑运算都可以放在 ON 子句内作为连结条件。</p>
<h4 id="非等值自左连结-LEFT-JOIN"><a href="#非等值自左连结-LEFT-JOIN" class="headerlink" title="非等值自左连结 LEFT JOIN"></a>非等值自左连结 LEFT JOIN</h4><p>希望对 product 表中的商品按照售价赋予排名. 一个从集合论出发,使用自左连结的思路是, 对每一种商品,找出售价不低于它的所有商品, 然后对售价不低于它的商品使用 COUNT 函数计数. 例如, 对于价格最高的商品,  </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  product_id
       <span class="token punctuation">,</span>product_name
       <span class="token punctuation">,</span>sale_price
       <span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>p2_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> my_rank
  <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token comment">--使用自左连结对每种商品找出价格不低于它的商品</span>
        <span class="token keyword">SELECT</span> P1<span class="token punctuation">.</span>product_id
               <span class="token punctuation">,</span>P1<span class="token punctuation">.</span>product_name
               <span class="token punctuation">,</span>P1<span class="token punctuation">.</span>sale_price
               <span class="token punctuation">,</span>P2<span class="token punctuation">.</span>product_id <span class="token keyword">AS</span> P2_id
               <span class="token punctuation">,</span>P2<span class="token punctuation">.</span>product_name <span class="token keyword">AS</span> P2_name
               <span class="token punctuation">,</span>P2<span class="token punctuation">.</span>sale_price <span class="token keyword">AS</span> P2_price 
          <span class="token keyword">FROM</span> product <span class="token keyword">AS</span> P1 
          <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P2 
            <span class="token keyword">ON</span> P1<span class="token punctuation">.</span>sale_price <span class="token operator">&lt;=</span> P2<span class="token punctuation">.</span>sale_price 
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> X
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_id<span class="token punctuation">,</span> product_name<span class="token punctuation">,</span> sale_price
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> my_rank<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注 1: COUNT 函数的参数是列名时, 会忽略该列中的缺失值, 参数为 * 时则不忽略缺失值。<br>注 2: 上述排名方案存在一些问题–如果两个商品的价格相等, 则会导致两个商品的排名错误, 例如,  叉子和打孔器的排名应该都是第六, 但上述查询导致二者排名都是第七. 试修改上述查询使得二者的排名均为第六。<br>注 3: 实际上, 进行排名有专门的函数, 这是 MySQL 8.0 新增加的窗口函数中的一种(窗口函数将在下一章学习), 但在较低版本的 MySQL 中只能使用上述自左连结的思路。</p>
<h3 id="交叉连结-CROSS-JOIN-笛卡尔积"><a href="#交叉连结-CROSS-JOIN-笛卡尔积" class="headerlink" title="交叉连结 CROSS JOIN(笛卡尔积)"></a>交叉连结 CROSS JOIN(笛卡尔积)</h3><p>之前的无论是外连结内连结, 一个共同的必备条件就是连结条件–ON 子句, 用来指定连结的条件. 如果你试过不使用这个连结条件的连结查询, 你可能已经发现, 结果会有很多行. 在连结去掉 ON 子句, 就是所谓的交叉连结(CROSS JOIN), 交叉连结又叫笛卡尔积, 后者是一个数学术语. 两个集合做笛卡尔积, 就是使用集合 A 中的每一个元素与集合 B 中的每一个元素组成一个有序的组合. 数据库表(或者子查询)的并,交和差都是在纵向上对表进行扩张或筛选限制等运算的, 这要求表的列数及对应位置的列的数据类型”相容”, 因此这些运算并不会增加新的列, 而交叉连接(笛卡尔积)则是在横向上对表进行扩张, 即增加新的列, 这一点和连结的功能是一致的. 但因为没有了ON子句的限制, 会对左表和右表的每一行进行组合, 这经常会导致很多无意义的行出现在检索结果中. 当然, 在某些查询需求中, 交叉连结也有一些用处。</p>
<p>交叉连结的语法有如下几种形式:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 1.使用关键字CROSS JOIN显式地进行交叉连结</span>
<span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
<span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP
 <span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> product <span class="token keyword">AS</span> P<span class="token punctuation">;</span>
<span class="token comment">--2.使用逗号分隔两个表,并省略 ON 子句</span>
<span class="token keyword">SELECT</span> SP<span class="token punctuation">.</span>shop_id
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>shop_name
       <span class="token punctuation">,</span>SP<span class="token punctuation">.</span>product_id
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>product_name
       <span class="token punctuation">,</span>P<span class="token punctuation">.</span>sale_price
  <span class="token keyword">FROM</span> shopproduct <span class="token keyword">AS</span> SP <span class="token punctuation">,</span> product <span class="token keyword">AS</span> P<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果中的记录数通常是两张表中行数的乘积<br>交叉连结没有应用到实际业务之中的原因有两个.一是其结果没有实用价值,二是由于其结果行数太多,需要花费大量的运算时间和高性能设备的支持。</p>
<h1 id="SQL高级处理"><a href="#SQL高级处理" class="headerlink" title="SQL高级处理"></a>SQL高级处理</h1><h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>窗口函数也称为<strong>OLAP函数</strong>。OLAP 是 <code>OnLine AnalyticalProcessing</code> 的简称，意思是对数据库数据进行实时分析处理。<br>为了便于理解，称之为 <code>窗口函数</code>。常规的SELECT语句都是对整张表进行查询，而窗口函数可以让我们有选择的去某一部分数据进行汇总、计算和排序。<br>窗口函数的通用形式：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">&lt;</span>窗口函数<span class="token operator">></span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>列名<span class="token operator">></span> <span class="token punctuation">]</span>
                     <span class="token punctuation">[</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>排序用列名<span class="token operator">></span> <span class="token punctuation">]</span><span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[   ]中的内容可以省略。<br>窗口函数最关键的是搞明白关键字 <strong>PARTITON BY</strong> 和 <strong>ORDER BY</strong> 的作用。<br><strong>PARTITON BY 子句</strong> 可选参数，指示如何将查询行划分为组，类似于 GROUP BY 子句的分组功能，但是 PARTITION BY 子句并不具备 GROUP BY 子句的汇总功能，并不会改变原始表中记录的行数。<br><strong>ORDER BY 子句</strong> 可选参数，指示如何对每个分区中的行进行排序，即决定窗口内，是按那种规则(字段)来排序的。<br><strong>注意</strong><br>虽然 <strong>PARTITON BY 子句</strong> 和 <strong>ORDER BY 子句</strong> 都是可选参数，但是两个参数不能同时没有（最少二选一）。不然， <code>&lt;窗口函数&gt; OVER( )</code> 这种用法没用实际意义（窗口由所有查询行组成，窗口函数使用所有行计算结果）。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> product_name
       <span class="token punctuation">,</span>product_type
       <span class="token punctuation">,</span>sale_price
       <span class="token punctuation">,</span>RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> product_type
                         <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> ranking
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到的结果是:<br><img src='/medias/image/2022-12-08-14-38-43.png' width="80%"></p>
<p>我们先忽略生成的新列 - [ranking]， 看下原始数据在PARTITION BY 和 ORDER BY 关键字的作用下发生了什么变化。<br>PARTITION BY 能够设定窗口对象范围。本例中，为了按照商品种类进行排序，我们指定了product_type。即一个商品种类就是一个小的”窗口”。<br>ORDER BY 能够指定按照哪一列、何种顺序进行排序。为了按照销售单价的升序进行排列，我们指定了sale_price。此外，窗口函数中的ORDER BY与SELECT语句末尾的ORDER BY一样，可以通过关键字ASC/DESC来指定升序/降序。省略该关键字时会默认按照ASC，也就是<br>升序进行排序中就省略了上述关键字。</p>
<h3 id="窗口函数种类"><a href="#窗口函数种类" class="headerlink" title="窗口函数种类"></a>窗口函数种类</h3><p>大致来说，窗口函数可以分为两类。<br>一是 将SUM、MAX、MIN等聚合函数用在窗口函数中<br>二是 RANK、DENSE_RANK等排序用的专用窗口函数</p>
<h4 id="专用窗口函数"><a href="#专用窗口函数" class="headerlink" title="专用窗口函数"></a>专用窗口函数</h4><ul>
<li><strong>RANK函数</strong><br>计算排序时，如果存在相同位次的记录，则会跳过之后的位次。<br>例）有 3 条记录排在第 1 位时：1 位、1 位、1 位、4 位……</li>
<li><strong>DENSE_RANK函数</strong><br>同样是计算排序，即使存在相同位次的记录，也不会跳过之后的位次。<br>例）有 3 条记录排在第 1 位时：1 位、1 位、1 位、2 位……</li>
<li><strong>ROW_NUMBER函数</strong><br>赋予唯一的连续位次。<br>例）有 3 条记录排在第 1 位时：1 位、2 位、3 位、4 位<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  product_name
       <span class="token punctuation">,</span>product_type
       <span class="token punctuation">,</span>sale_price
       <span class="token punctuation">,</span>RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> ranking
       <span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> dense_ranking
       <span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> row_num
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h4 id="聚合函数在窗口函数上的使用"><a href="#聚合函数在窗口函数上的使用" class="headerlink" title="聚合函数在窗口函数上的使用"></a>聚合函数在窗口函数上的使用</h4><p>聚合函数在窗口函数中的使用方法和之前的专用窗口函数一样，只是出来的结果是一个<strong>累计</strong>的聚合函数值。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  product_id
       <span class="token punctuation">,</span>product_name
       <span class="token punctuation">,</span>sale_price
       <span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> current_sum
       <span class="token punctuation">,</span><span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> current_avg  
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src='/medias/image/2022-12-08-14-44-11.png' width="80%">
<img src='/medias/image/2022-12-08-14-44-21.png' width="80%">
可以看出，聚合函数结果是，按我们指定的排序，这里是product_id，**当前所在行及之前所有的行**的合计或均值。即累计到当前行的聚合。


<h3 id="窗口函数的的应用"><a href="#窗口函数的的应用" class="headerlink" title="窗口函数的的应用"></a>窗口函数的的应用</h3><h4 id="计算移动平均"><a href="#计算移动平均" class="headerlink" title="计算移动平均"></a>计算移动平均</h4><p>在上面提到，聚合函数在窗口函数使用时，计算的是累积到当前行的所有的数据的聚合。 实际上，还可以指定更加详细的<strong>汇总范围</strong>。该汇总范围称为 <strong>框架</strong> (frame)。</p>
<p>语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">&lt;</span>窗口函数<span class="token operator">></span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>排序用列名<span class="token operator">></span>
                 <span class="token keyword">ROWS</span> n <span class="token keyword">PRECEDING</span> <span class="token punctuation">)</span>  
                 
<span class="token operator">&lt;</span>窗口函数<span class="token operator">></span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>排序用列名<span class="token operator">></span>
                 <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> n <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> n <span class="token keyword">FOLLOWING</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PRECEDING（“之前”）， 将框架指定为 “截止到之前 n 行”，加上自身行<br>FOLLOWING（“之后”）， 将框架指定为 “截止到之后 n 行”，加上自身行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  product_id
       <span class="token punctuation">,</span>product_name
       <span class="token punctuation">,</span>sale_price
       <span class="token punctuation">,</span><span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product_id
                               <span class="token keyword">ROWS</span> <span class="token number">2</span> <span class="token keyword">PRECEDING</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> moving_avg
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意观察框架的范围。<br><img src='/medias/image/2022-12-08-14-46-15.png' width="80%"></p>
<p>BETWEEN 1 PRECEDING AND 1 FOLLOWING，将框架指定为 “之前1行” + “之后1行” + “自身”</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  product_id
       <span class="token punctuation">,</span>product_name
       <span class="token punctuation">,</span>sale_price
       <span class="token punctuation">,</span><span class="token function">AVG</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product_id
                               <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token number">1</span> <span class="token keyword">FOLLOWING</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> moving_avg  
  <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src='/medias/image/2022-12-08-14-46-51.png' width="80%">

<ul>
<li>原则上，窗口函数只能在SELECT子句中使用。</li>
<li>窗口函数OVER 中的ORDER BY 子句并不会影响最终结果的排序。其只是用来决定窗口函数按何种顺序计算。</li>
</ul>
<h2 id="GROUPING运算符"><a href="#GROUPING运算符" class="headerlink" title="GROUPING运算符"></a>GROUPING运算符</h2><h3 id="ROLLUP-合计及小计"><a href="#ROLLUP-合计及小计" class="headerlink" title="ROLLUP 合计及小计"></a>ROLLUP 合计及小计</h3><p>常规的GROUP BY 只能得到每个分类的小计，有时候还需要计算分类的合计，可以用 ROLLUP关键字。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  product_type
       <span class="token punctuation">,</span>regist_date
       <span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span> <span class="token keyword">AS</span> sum_price
  <span class="token keyword">FROM</span> product
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> product_type<span class="token punctuation">,</span> regist_date <span class="token keyword">WITH ROLLUP</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src='/medias/image/2022-12-08-14-49-52.png' width="50%">
这里ROLLUP 对product_type, regist_date两列进行合计汇总。结果实际上有三层聚合，如下图 模块3是常规的 GROUP BY 的结果，需要注意的是衣服 有个注册日期为空的，这是本来数据就存在日期为空的，不是对衣服类别的合计； 模块2和1是 ROLLUP 带来的合计，模块2是对产品种类的合计，模块1是对全部数据的总计。


                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">万川</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://notego.top/2021/03/31/sql/">http://notego.top/2021/03/31/sql/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">万川</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/SQL/">
                                    <span class="chip bg-color">SQL</span>
                                </a>
                            
                                <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                    <span class="chip bg-color">数据库</span>
                                </a>
                            
                                <a href="/tags/%E4%B8%BB%E9%94%AE/">
                                    <span class="chip bg-color">主键</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你好，同行的有缘人</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/03/31/ji-qi-xue-xi/">
                    <div class="card-image">
                        
                        <img src="/medias/image/ml2.jpg" class="responsive-img" alt="机器学习">
                        
                        <span class="card-title">机器学习</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            为学日益，为道日损
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-03-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    机器学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%AE%97%E6%B3%95/">
                        <span class="chip bg-color">算法</span>
                    </a>
                    
                    <a href="/tags/%E6%A8%A1%E5%9E%8B/">
                        <span class="chip bg-color">模型</span>
                    </a>
                    
                    <a href="/tags/%E7%9B%91%E7%9D%A3%E5%AD%A6%E4%B9%A0/">
                        <span class="chip bg-color">监督学习</span>
                    </a>
                    
                    <a href="/tags/%E6%97%A0%E7%9B%91%E7%9D%A3%E5%AD%A6%E4%B9%A0/">
                        <span class="chip bg-color">无监督学习</span>
                    </a>
                    
                    <a href="/tags/%E7%89%B9%E5%BE%81/">
                        <span class="chip bg-color">特征</span>
                    </a>
                    
                    <a href="/tags/%E8%BF%87%E6%8B%9F%E5%90%88/">
                        <span class="chip bg-color">过拟合</span>
                    </a>
                    
                    <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">
                        <span class="chip bg-color">机器学习</span>
                    </a>
                    
                    <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">
                        <span class="chip bg-color">深度学习</span>
                    </a>
                    
                    <a href="/tags/%E6%A6%82%E7%8E%87/">
                        <span class="chip bg-color">概率</span>
                    </a>
                    
                    <a href="/tags/%E6%B3%9B%E5%8C%96/">
                        <span class="chip bg-color">泛化</span>
                    </a>
                    
                    <a href="/tags/%E5%81%8F%E5%B7%AE/">
                        <span class="chip bg-color">偏差</span>
                    </a>
                    
                    <a href="/tags/%E6%96%B9%E5%B7%AE/">
                        <span class="chip bg-color">方差</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/03/31/python/">
                    <div class="card-image">
                        
                        <img src="/medias/image/Python.jpg" class="responsive-img" alt="Python">
                        
                        <span class="card-title">Python</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            优雅
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" class="post-category">
                                    编程语言
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Python/">
                        <span class="chip bg-color">Python</span>
                    </a>
                    
                    <a href="/tags/JSON/">
                        <span class="chip bg-color">JSON</span>
                    </a>
                    
                    <a href="/tags/numpy/">
                        <span class="chip bg-color">numpy</span>
                    </a>
                    
                    <a href="/tags/pandas/">
                        <span class="chip bg-color">pandas</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('20')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 方寸田园<br />'
            + '文章作者: 万川<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">万川</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">168.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "3";
                    var startDate = "31";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wanc97" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:wanc97@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3221927185" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3221927185" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI4MzEzNjIxNw==#wechat_redirect" class="tooltipped" target="_blank" data-tooltip="微信联系我: W3221927185" data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

    <!-- 雪花特效 --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</body>

</html>
