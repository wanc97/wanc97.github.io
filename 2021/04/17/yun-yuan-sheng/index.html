<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="云原生, 方寸田园">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>云原生 | 方寸田园</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="方寸田园" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>




<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">方寸田园</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">方寸田园</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wanc97" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wanc97" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/image/2022-09-05-17-46-49.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">云原生</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                <span class="chip bg-color">微服务</span>
                            </a>
                        
                            <a href="/tags/%E5%AE%B9%E5%99%A8/">
                                <span class="chip bg-color">容器</span>
                            </a>
                        
                            <a href="/tags/Docker/">
                                <span class="chip bg-color">Docker</span>
                            </a>
                        
                            <a href="/tags/kubernetes/">
                                <span class="chip bg-color">kubernetes</span>
                            </a>
                        
                            <a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/">
                                <span class="chip bg-color">模块化</span>
                            </a>
                        
                            <a href="/tags/%E7%8B%AC%E7%AB%8B%E9%83%A8%E7%BD%B2/">
                                <span class="chip bg-color">独立部署</span>
                            </a>
                        
                            <a href="/tags/%E6%9D%BE%E8%80%A6%E5%90%88/">
                                <span class="chip bg-color">松耦合</span>
                            </a>
                        
                            <a href="/tags/%E5%BA%B7%E5%A8%81%E6%B3%95%E5%88%99/">
                                <span class="chip bg-color">康威法则</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-category">
                                计算机
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-04-17
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-04-21
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    31 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="微服务基础-amp-理论"><a href="#微服务基础-amp-理论" class="headerlink" title="微服务基础&amp;理论"></a>微服务基础&amp;理论</h2><h3 id="微服务特点"><a href="#微服务特点" class="headerlink" title="微服务特点"></a>微服务特点</h3><blockquote>
<ul>
<li>一组小的服务</li>
<li>独立的进程</li>
<li>轻量级通信</li>
<li>基于业务能力</li>
</ul>
</blockquote>
<h3 id="微服务利弊"><a href="#微服务利弊" class="headerlink" title="微服务利弊"></a>微服务利弊</h3><h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><ul>
<li>强模块化边界：清晰的边界</li>
<li>可独立部署：无集中式管理，松耦合</li>
<li>技术多样性：可以用不同语言开发</li>
<li>故障容忍：错误隔离，自动重启</li>
</ul>
<h4 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h4><ul>
<li>不恰当的设计会增加系统的复杂程度</li>
<li> 分布式复杂性</li>
<li>最终一致性：不同服务对相同数据进行操作时需要注意一致性</li>
<li>运维复杂性</li>
<li>测试复杂性</li>
</ul>
<h3 id="康威法则"><a href="#康威法则" class="headerlink" title="康威法则"></a>康威法则</h3><p>设计系统的架构受制于产生这些设计的组织的沟通结构。<br>随着组织扩大，沟通成本越来越大，会降低开发效率，微服务的思路可以应对这种情况。</p>
<p>随着问题负责性增加，单块服务的效率下降更快，而微服务下降较慢，这是微服务的优势；<br>同时使用微服务有着额外开支（固定成本等）；<br>所以对于小系统更适合单块服务，而高复杂性的系统适合微服务。</p>
<h3 id="中台"><a href="#中台" class="headerlink" title="中台"></a>中台</h3><p>服务分层，每一层向上提供支撑；<br>从低到高包括技术中台、业务中台、业务前台</p>
<p><strong>技术中台</strong>包括<strong>运维层</strong>（IaaS：提供计算、存储、网络、监控等基础设施）和<strong>平台层</strong>（PaaS：服务框架、资源调度等；大数据/AI平台），运维层向平台层提供支撑。</p>
<p>微服务可以简单分为基础服务和聚合服务，其中基础服务是实现比较底层、公共、核心的功能，聚合服务则主要调用基础服务，向外提供适配服务。</p>
<h3 id="服务治理"><a href="#服务治理" class="headerlink" title="服务治理"></a>服务治理</h3><ul>
<li>服务注册、发现</li>
<li>服务负载均衡、路由</li>
<li>日志</li>
<li>监控：调用量、延迟等</li>
<li>限流熔断</li>
<li>安全控制</li>
<li>统一异常处理</li>
<li>文档</li>
</ul>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><ul>
<li>消费者通过域名向LB获取生产者服务，要穿透LB效率偏低，LB集中，危险性上升；</li>
<li>LB集成到消费者中，效率有提升，但每个消费者都建立客户端代价提升；</li>
<li>每个主机用一个LB，折中方案。</li>
</ul>
<h3 id="API网关"><a href="#API网关" class="headerlink" title="API网关"></a>API网关</h3><p>对外屏蔽细节、将外部请求转化为具体微服务请求<br>限定流量<br>日志监控</p>
<h3 id="微服务通信方式"><a href="#微服务通信方式" class="headerlink" title="微服务通信方式"></a>微服务通信方式</h3><table>
<thead>
<tr>
<th align="center"></th>
<th align="center">RPC</th>
<th align="center">REST</th>
</tr>
</thead>
<tbody><tr>
<td align="center">耦合性</td>
<td align="center">强耦合（服务端与客服端消息格式匹配）</td>
<td align="center">松耦合</td>
</tr>
<tr>
<td align="center">消息协议</td>
<td align="center">二进制：thrift、protobuf</td>
<td align="center">文本：xml、json</td>
</tr>
<tr>
<td align="center">通信协议</td>
<td align="center">TCP</td>
<td align="center">HTTP/HTTP2</td>
</tr>
<tr>
<td align="center">性能</td>
<td align="center">高</td>
<td align="center">相对差一些</td>
</tr>
<tr>
<td align="center">借口契约IDL</td>
<td align="center">thrift、protobuf等的IDL</td>
<td align="center">swagger</td>
</tr>
<tr>
<td align="center">客户端</td>
<td align="center">强类型客户端，一般自动生成，支持多语言</td>
<td align="center">一般HTTP客户端</td>
</tr>
<tr>
<td align="center">案例</td>
<td align="center">dubbo、thrft</td>
<td align="center">spring MVC</td>
</tr>
<tr>
<td align="center">开发者友好</td>
<td align="center">客户端使用方便，但二进制不便于调试</td>
<td align="center">文本消息可读，浏览器调试</td>
</tr>
<tr>
<td align="center">对外开放</td>
<td align="center">对外转换成REST/文本协议</td>
<td align="center">可以直接对外开放</td>
</tr>
</tbody></table>
<h3 id="微服务监控体系"><a href="#微服务监控体系" class="headerlink" title="微服务监控体系"></a>微服务监控体系</h3><ul>
<li>用户体验监控：使用性能、地区等信息</li>
<li>业务监控：核心指标</li>
<li>应用层监控：URL、服务的可用率、响应时间</li>
<li>系统层监控：cpu、内存、硬盘等</li>
<li>基础设施监控：网络流量、丢包、错报、连接数</li>
</ul>
<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><ul>
<li>开源的应用容器引擎</li>
<li>依赖于已存在并运行的Linux内核环境。实质上是在已经运行的Linux下制造了一个隔离的文件环境，因此它执行的效率几乎等同于所部署的Linux主机。因此，Docker 必须部署在Linux内核的系统上。如果其他系统想部署 Docker 就必须安装一个虚拟Linux环境。</li>
</ul>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>解决环境依赖，完全使用沙箱机制，相互之间不会有任何接口</li>
<li>轻量、独立、可执行、包含运行应用所需的所有工具</li>
<li>带来开发环境的一致性</li>
<li>便于多版本混合部署</li>
<li>容器是进程，共享OS内核，与虚拟机有本质区别</li>
<li>位于容器引擎层，是基于IaaS基础设施层的</li>
<li>容器是『单进程』模型，只有PID=1的进程才会被Dockerd控制，即pid=1的进程挂了Dockerd能够感知到，但是其它的进程却不受Dockerd的管理，当出现孤儿进程的时候，管理和调度是个问题。</li>
</ul>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>仍然有较多开销，不适合把特别轻量的任务都做成微服务</li>
<li>更加适合immutable的服务</li>
<li>自身不稳定，需要配套的自动恢复功能</li>
</ul>
<h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><ul>
<li>镜像（Image）：相当于是一个root文件系统。比如官方镜像 ubuntu:16.04就包含了完整的一套Ubuntu16.04最小系统的root文件系统。</li>
<li>容器（Container）：<ul>
<li>镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。</li>
<li>容器可以被创建、启动、暂停、停止、删除等。</li>
<li>容器的实质是进程，但有独立的命名空间。因此有自己的root文件系统、网络配置、进程空间，甚至自己的用户ID空间。容器内的进程是运行在一个隔离的环境里，就好像是在一个独立于宿主的系统下操作一样。</li>
<li>容器消亡时，容器存储层也随之消亡。因此，容器存储层的信息都会随容器删除而丢失。</li>
</ul>
</li>
<li>Registry：可以包含多个仓库（Repository）<ul>
<li>&lt;仓库名&gt;:&lt;标签&gt; 的格式来指定具体是这个软件哪个版本的镜像</li>
<li>仓库（Repository）：仓库可看成一个代码控制中心，用来保存镜像，一个仓库会包含同一个软件不同版本的镜像。</li>
<li>每个仓库可以包含多个标签（Tag），每个标签对应一个镜像，如果不给出标签，将以latest作为默认标签。</li>
</ul>
</li>
<li>Docker使用客户端-服务器 (C/S) 架构模式，使用远程API来管理和创建Docker容器。<ul>
<li>客户端：通过命令行或者其他工具与Docker的守护进程通信。</li>
<li>主机(Host)：物理或者虚拟的机器用于执行 Docker 守护进程和容器。</li>
</ul>
</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ul>
<li>docker pull：拉取镜像</li>
<li>docker run：运行容器<ul>
<li>it：在终端中交互运行</li>
<li>d：后台运行</li>
</ul>
</li>
<li>docker pause/unpause：容器暂停/恢复运行</li>
<li>docker stop：停止容器</li>
<li>docker start/restart：启动stop的容器</li>
<li>docker attach：进入容器，给正在运行的容器分配stdin、stdout 和 stderr，因此退出暂停</li>
<li>docker exec：进入容器，相当于fork了一个进程，退出不暂停</li>
<li>docker ps：查看正在运行的容器<ul>
<li>a：所有容器</li>
</ul>
</li>
<li>docker stats：查看运行容器的资源消耗量</li>
<li>docker logs：查看容器内的输出</li>
<li>docker export：导出容器为本地快照，如：docker export f23c03060d4e &gt; ./test/test.tar</li>
<li>docker import：导入快照为镜像，如：cat test/test.tar |docker import - test/test_image:v1.0</li>
<li>docker rm：删除容器，docker container prune清理所有处于中止状态的容器</li>
<li> docker images：本地镜像</li>
<li> docker search：搜索镜像</li>
<li> docker rmi：删除镜像</li>
<li> docker commit：从容器生成新镜像</li>
<li> docker history：查看镜像的分层</li>
<li> docker inspect：查看镜像的详细信息</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动守护进程</span>
<span class="token function">service</span> docker start
<span class="token comment"># 命令用法</span>
docker pull <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> NAME<span class="token punctuation">[</span>:TAG<span class="token operator">|</span>@DIGEST<span class="token punctuation">]</span>
docker run <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> IMAGE <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARG<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
docker stop <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER <span class="token punctuation">[</span>CONTAINER<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
docker stats <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token punctuation">[</span>CONTAINER<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
docker logs <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER
docker commit <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER <span class="token punctuation">[</span>REPOSITORY<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span><span class="token punctuation">]</span>
docker <span class="token function">history</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> IMAGE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><ul>
<li>构建镜像的文本文件，包含构建镜像所需的指令和说明。<ul>
<li>首字母必须大写D</li>
<li>尽量将Dockerfile放在空目录中。</li>
<li>每个容器尽量只有一个功能。</li>
<li>执行的命令越少越好。</li>
</ul>
</li>
<li>FROM：定制的镜像都是基于FROM后面的基础镜像</li>
<li>RUN：在制作容器即配置环境时8执行的命令，可将多个命令用&amp;&amp;连接、用\换行，以降低镜像层数。</li>
<li>COPY：从上下文目录中复制文件或者目录到容器里指定路径。</li>
<li>ADD：和COPY的使用格类似，区别在会对一些压缩文件自动解压</li>
<li>CMD：类似于RUN指令，用于运行程序。<ul>
<li>CMD在docker run时运行，RUN是在docker build时运行。</li>
<li>作用为启动的容器指定默认要运行的程序，程序运行结束，容器也就结束。</li>
<li>如果Dockerfile中如果存在多个CMD指令，仅最后一个生效。</li>
<li>CMD指令指定的程序可被docker run命令行参数中指定要运行的程序所覆盖。</li>
</ul>
</li>
<li>ENTRYPOINT：类似于CMD指令，但不会被docker run的命令行参数指定的指令所覆盖，而且这些命令行参数会被当作参数送给ENTRYPOINT指令指定的程序。</li>
<li>ENV：设置环境变量</li>
<li>ARG：设置环境变量，作用域只有docker build的过程中</li>
<li>VOLUME：定义匿名数据卷。在启动容器时忘记挂载数据卷，会自动挂载到匿名卷。</li>
<li>WORKDIR：指定工作目录</li>
<li>LABEL：给镜像添加元数据</li>
<li>docker build：构建镜像<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token environment constant">PATH</span> <span class="token operator">|</span> URL <span class="token operator">|</span> -
<span class="token comment"># 如：docker build -t test/test_image:v3.0 .</span>
COPY <span class="token punctuation">[</span>--chown<span class="token operator">=</span><span class="token operator">&lt;</span>user<span class="token operator">></span>:<span class="token operator">&lt;</span>group<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>源路径<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token punctuation">..</span>.  <span class="token operator">&lt;</span>目标路径<span class="token operator">></span>
ENV <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token operator">&lt;</span>value<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="基础镜像"><a href="#基础镜像" class="headerlink" title="基础镜像"></a>基础镜像</h3><ul>
<li>ubuntu、centos相对较大</li>
<li>BusyBox是一个精简工具集合，非常小，1M多</li>
<li>Alphine在BusyBox的基础上更加完善，同时保持瘦身，大约5M</li>
</ul>
<h3 id="隔离技术"><a href="#隔离技术" class="headerlink" title="隔离技术"></a>隔离技术</h3><ul>
<li>容器是使用namespace进行隔离，cgroup进行资源限制，并且带有rootfs的进程。</li>
<li>启用Linux Namespace配置；</li>
<li>设置指定的Cgroups参数；</li>
<li>切换进程的根目录（Change Root）。</li>
</ul>
<h4 id="NameSpace"><a href="#NameSpace" class="headerlink" title="NameSpace"></a>NameSpace</h4><ul>
<li>Linux同属于一个namespace中进程可以感知到彼此，而对外界的进程一无所知。docker正是使用这个技术实现资源隔离。</li>
<li>Linux提供了六种隔离：<ul>
<li>IPC：CLONE_NEWIPC，IPC（信号量、消息队列和共享内存等）隔离</li>
<li>Network：CLONE_NEWNET，网络隔离（网络栈、端口等）</li>
<li>Mount：CLONE_NEWNS，挂载点（文件系统）</li>
<li>PID：CLONE_NEWPID，进程编号</li>
<li>User：CLONE_NEWUSER，用户和用户组</li>
<li>UTS：CLONE_NEWUTS，主机名和域名</li>
</ul>
</li>
<li>unshare：可以实现当前进程父进程的隔离</li>
<li>setns：将进程加入到指定的namespace中</li>
</ul>
<h4 id="CGroups"><a href="#CGroups" class="headerlink" title="CGroups"></a>CGroups</h4><ul>
<li>限制一个进程组能够使用的资源上限，CPU，内存、磁盘、网络带宽等等。docker也是使用CGroups来控制容器的资源使用量。</li>
<li>cgroup：系统进行限制的一组进程。CGroups中的资源限制都是以进程组为单位实现的，一个进程可以加入到某个进程组，从而受到相同的资源限制。</li>
<li>task：在CGroups中，task可以理解为一个进程。</li>
<li>hierarchy：可以理解成层级关系，CGroups的组织关系就是层级的形式，每个节点都是一个cgroup。cgroup可以有多个子节点，子节点默认继承父节点的属性。</li>
<li>subsystem：更准确的表述应该是resource controllers，也就是资源控制器，cpu子系统负责控制cpu时间的分配。子系统必须应用（attach）到一个 hierarchy上才能起作用。包括：<ul>
<li>cpu：限制进程的cpu使用率；</li>
<li>cpuacct：统计CGroups中的进程的cpu使用情况；</li>
<li>cpuset：为CGroups中的进程分配单独的cpu节点或者内存节点；</li>
<li>memory：限制进程的内存使用；</li>
<li>devices：可以控制进程能够访问哪些设备；</li>
<li>blkio：限制进程的块设备IO；</li>
<li>freezer：挂起或者恢复CGroups中的进程；</li>
<li>net_cls：标记进程的网络数据包，然后可以使用防火墙或者tc模块（traffic controller）控制该数据包。这个控制器只适用从该cgroup离开的网络包，不适用到达该cgroup的网络包；</li>
<li>ns：将不同CGroups下面的进程应用不同的namespace；</li>
<li>perf_event：监控CGroups中的进程的perf事件；</li>
<li>pids：限制一个cgroup以及它的子节点中可以创建的进程数目；</li>
<li>rdma：限制cgroup中可以使用的 RDMA 资源。</li>
</ul>
</li>
</ul>
<h4 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h4><ul>
<li>通过chroot或pivot_root可以修改进程的根目录，这是文件系统隔离的基础</li>
<li>容器镜像rootfs，是包含操作系统所有文件和目录但不包含内核的文件系统</li>
<li>rootfs是以层的方式增量叠放在一起</li>
<li>rootfs由只读层、init层、可读写层组成<ul>
<li>只读层：由若干层增量组成，组成的镜像。不可变，不commit</li>
<li>可读写层：存放容器运行后的改变，对只读层的删除操作是在可读写层做了一个whiteout遮盖。可变，commit</li>
<li>init层：存放一些只在当前容器有效，且不需要commit的内容。可变，不commit</li>
</ul>
</li>
<li>容器运行就是在只读层上面加一个可读写层<ul>
<li>同一个镜像的多个容器底层共享</li>
<li>容器删除后，可读写层消失</li>
<li>容器commit就是把可读写层存为只读层</li>
</ul>
</li>
<li>AUFS、OverlayFS等联合挂载技术将各层的文件整合成一个文件系统</li>
<li>Docker Volume在rootfs准备好之后，在执行chroot之前把宿主机目录挂载到容器目录，可以在保证隔离的情况下使得容器和宿主机之间可以进行文件操作。挂载目录仍然属于宿主机而不在容器的可读写层。</li>
</ul>
<h3 id="进程回收"><a href="#进程回收" class="headerlink" title="进程回收"></a>进程回收</h3><ul>
<li>当父进程没有对子进程进行回收时，Linux将子进程的父进程设为1号进程，并由1号进程进行回收</li>
<li>而容器的1号进程entry point并不具备管理多进程、多线程等复杂场景下的能力，因此容器更适合再单进程场景下使用。</li>
<li>k8s可以给容器提供一个/pause进程来处理僵尸进程</li>
</ul>
<h2 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h2><ul>
<li>Kubernetes是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，方便进行声明式配置和自动化。</li>
</ul>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ul>
<li>容器集群管理、协调系统，位于容器编排层，基于容器引擎层，在Docker之上</li>
<li>编排存储：自动挂载存储系统，例如本地存储、公共云等</li>
<li>协助实现大规模云端部署<ul>
<li>服务发现：对外提供统一入口</li>
<li>协调、提供计算资源</li>
<li>自动扩缩容</li>
<li>自动部署和回滚</li>
<li>对失败的容器自动重启</li>
<li>单例模式</li>
</ul>
</li>
</ul>
<h3 id="组成结构"><a href="#组成结构" class="headerlink" title="组成结构"></a>组成结构</h3><img src='/medias/image/2022-11-02-12-11-29.png' width="100%">

<ul>
<li>由管理节点master和工作节点node组成</li>
<li>master：接受外部请求；调度<ul>
<li>API Server：统一访问入口，协调其它组件，RESTful API提供接口服务，所有对象资源的增删改查和监听操作都交给API Server处理后再提交给Etcd存储。</li>
<li>Etcd：一致性、高可用性、分布式键值存储系统，用于保存集群状态数据，如pod、Service等对象信息</li>
<li>scheduler：对容器运行、节点分布进行调度；根据调度算法为新创建的Pod选择一个Node</li>
<li>controller-manager：管理各个资源的控制器，负责后台任务的运维、管理、升级、回滚。这些控制器包括：<ul>
<li>节点控制器（Node Controller）：负责在节点出现故障时进行通知和响应</li>
<li>任务控制器（Job Controller）：监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成</li>
<li>端点控制器（Endpoints Controller）：填充端点（Endpoints）对象（即加入 Service 与 Pod）</li>
<li>服务帐户和令牌控制器（Service Account &amp; Token Controllers）：为新的命名空间创建默认帐户和 API 访问令牌</li>
</ul>
</li>
</ul>
</li>
<li>node：工作节点<ul>
<li>kubelet：master在每个节点的代理，管理节点的容器<ul>
<li>通过CRI（Container Runtime Interface）的远程调用接口进行交互，接口定义了容器运行时的各项核心操作</li>
</ul>
</li>
<li>kube-proxy：负责pod网络代理，确保每个节点都获得其IP地址，实现本地iptables和规则以处理路由和流量负载均衡。</li>
<li>第三方容器引擎，如docker</li>
<li>pod：最小管理单元，可以包含多个容器，类似于进程组</li>
</ul>
</li>
<li>插件：实现集群功能<ul>
<li>DNS：为 Kubernetes 服务提供DNS记录</li>
<li>Web界面（Dashboard）：Kubernetes 集群的通用的、基于 Web 的用户界面。 它使用户可以管理集群中运行的应用程序以及集群本身， 并进行故障排除。</li>
<li>容器资源监控：将关于容器的一些常见的时间序列度量值保存到一个集中的数据库中， 并提供浏览这些数据的界面</li>
<li>集群层面日志：机制负责将容器的日志数据保存到一个集中的日志存储中， 这种集中日志存储提供搜索和浏览接口。</li>
</ul>
</li>
</ul>
<h4 id="Kubernetes-对象"><a href="#Kubernetes-对象" class="headerlink" title="Kubernetes 对象"></a>Kubernetes 对象</h4><ul>
<li>Kubernetes对象是持久化的实体。用于表示整个集群的状态。<ul>
<li>它们描述了如下信息：<ul>
<li>哪些容器化应用正在运行（以及在哪些节点上运行）</li>
<li>可以被应用使用的资源</li>
<li>关于应用运行时表现的策略，比如重启策略、升级策略，以及容错策略</li>
</ul>
</li>
<li>spec：期望状态<ul>
<li>必须在创建对象时设置其内容。</li>
<li>大多数情况下通过.yaml文件为kubectl提供这些信息</li>
<li>不同Kubernetes对象的spec是不同的，包含特定该对象的嵌套字段。</li>
</ul>
</li>
<li>status：当前实际状态<ul>
<li>由Kubernetes系统和组件设置并更新的。Kubernetes会积极地管理当前实际状态，以使之达成期望状态。如：副本数量</li>
</ul>
</li>
<li>yaml文件中，需要配置的字段：<ul>
<li>apiVersion：创建该对象所使用的Kubernetes API的版本</li>
<li>kind：指定要创建的 Kubernetes 对象的类型，例如 Pod、Service、Deployment 等。</li>
<li>metadata：指定 Kubernetes 对象的元数据，包括对象的名称、命名空间、标签等信息。</li>
<li>spec：期望的该对象的状态，包括对象的配置信息、参数等。<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>container
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li>上面的 YAML 文件定义了一个名为 “my-pod” 的 Pod 对象，它包含一个名为 “my-container” 的容器，该容器使用了 “nginx:latest” 镜像。</li>
</ul>
</li>
<li>kubectl管理对象<ul>
<li>指令式命令：作用于活跃对象，直接进行更改<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 通过创建 Deployment 对象来运行 nginx 容器的实例：</span>
kubectl create deployment nginx --image nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li>指令式对象配置：作用于单个文件<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建配置文件中定义的对象：</span>
kubectl create -f nginx.yaml
<span class="token comment"># 删除两个配置文件中定义的对象：</span>
kubectl delete -f nginx.yaml -f redis.yaml
<span class="token comment"># 通过覆盖活动配置来更新配置文件中定义的对象：</span>
kubectl replace -f nginx.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li>每个对象都有name来标识同类资源中的唯一性，和UID来标识在整个集群中的唯一性</li>
<li>命名空间（namespace）：同一集群中的资源划分为相互隔离的组。<ul>
<li>适用于存在跨多个团队或项目的场景。小集群一般不需要</li>
<li>namespace内资源的名称唯一，不同namespace之间可以不唯一<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出集群中现存的namespace</span>
kubectl get namespace<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li>初始namespace:<ul>
<li>default：没有指明使用其它名字空间的对象所使用的默认名字空间</li>
<li>kube-system：系统创建对象所使用的名字空间</li>
<li>kube-public：所有用户都可以读取</li>
<li>kube-node-lease 用于与各个节点相关的租约（Lease）对象。 节点租期允许kubelet发送心跳，由此控制面能够检测到节点故障。</li>
</ul>
</li>
<li>创建一个服务时，会创建一个相应的DNS条目 &lt;服务名称&gt;.&lt;名字空间名称&gt;.svc.cluster.local，这意味着如果容器只使用 &lt;服务名称&gt;，它将被解析到本地名字空间的服务。这对于跨多个名字空间（如开发、分级和生产） 使用相同的配置非常有用。跨名字空间访问则需要使用完全限定域名（FQDN）。</li>
</ul>
</li>
<li>标签：附加到对象上的键值对</li>
</ul>
<p>以下是 Kubernetes 中最重要的几种对象：</p>
<ul>
<li>Pod：Kubernetes 中最小的可部署对象，通常包含一个或多个容器。Pod是部署和管理应用程序的最小单元。</li>
<li>Service：用于暴露 Pod 中的应用程序。Service为应用程序提供了一个稳定的IP地址，从而使其他应用程序可以轻松地连接到它。</li>
<li>ReplicaSet：一种控制器，用于确保在 Kubernetes中运行指定数量的Pod副本。如果Pod数量不足或超过指定数量，ReplicaSet将自动进行缩放。</li>
<li>Deployment：用于在Kubernetes中部署应用程序。Deployment可以创建和更新 ReplicaSet，以确保在任何时候都可以运行指定数量的Pod副本。</li>
<li>ConfigMap和Secret：ConfigMap和Secret是用于管理应用程序配置和敏感数据的对象。ConfigMap用于存储非敏感的配置数据，而Secret则用于存储敏感的数据，例如密码或API密钥。</li>
</ul>
<p>除此之外，还有其他的对象类型，例如StatefulSet、Job和CronJob等，它们都用于在 Kubernetes中实现不同的应用程序管理和部署场景。</p>
<h3 id="作业管理"><a href="#作业管理" class="headerlink" title="作业管理"></a>作业管理</h3><ul>
<li>每一个控制器，都以独有的方式负责某种编排功能，</li>
<li>控制器都遵循一个通用编排模式：控制循环（control loop）；不断将实际状态调整为期望状态</li>
<li>控制器的设计原理就是用一种对象管理另一种对象；控制器的yaml定义中上半部分是控制器定义（包括期望状态），上下半部分是被控制对象（pod）的模板；让下面对象的状态达到上面的设定</li>
</ul>
<h4 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h4><p>尽管容器可以为应用程序提供独立的运行环境，但在某些情况下，它们可能不足以满足特定的需求。这时候，Pod可以为容器提供一个更完整的运行环境，从而使得多个容器可以协同工作。</p>
<ul>
<li>为什么要从容器变为pod？<ul>
<li>僵尸进程的问题使得容器只适合单进程模式</li>
<li>容器的作用是隔离环境，但是隔离得太死了，限制了单进程的发挥</li>
<li>pod的作用是从容器中拆开一些口，保证容器间必要的交流</li>
</ul>
</li>
<li>常见方式：通过让pod中的多个容器共享volume、网络等进行交流</li>
<li>常见字段：<ul>
<li>NodeSelector：标签选择器，以便将Pod调度到具有相应标签的节点上</li>
<li>NodeName：经过了调度后被赋值为节点名</li>
<li>HostAliases：定义了Pod的hosts文件（比如/etc/hosts）里的内容</li>
</ul>
</li>
<li>投射数据卷（Projected Volume）：为容器提供预先定义好的数据。<ul>
<li>Secret：把Pod想要访问的加密数据存放到Etcd中，然后通过在Pod的容器里挂载Volume访问</li>
<li>ConfigMap：不需要加密的、应用所需的配置信息；</li>
<li>Downward API：让Pod里的容器能够直接获取到这个Pod API对象（YAML文件）本身的信息；</li>
</ul>
</li>
<li>PodPreset：Kubernetes中的一种资源类型，用于在Pod创建时自动注入一些预设值。它可以通过注入环境变量、挂载卷、设置资源限制等方式，为Pod提供一些自定义的配置，以满足不同的应用场景需求。</li>
</ul>
<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>Deployment是一种控制器对象，它管理着一组Pod的创建、更新和删除。Deployment使用Pod模板来定义所创建的Pod的规范，通过控制器的方式保证这些Pod的副本数一直保持在指定的数量范围内。如果有Pod失败或需要更新，Deployment将会自动重启或升级Pod。</p>
<ul>
<li>功能：<ul>
<li>以滚动更新（rolling update）的方式实现升级pod，可以控制Pod的更新速度，使得更新过程中不会影响应用程序的可用性。</li>
<li>水平扩展/收缩</li>
</ul>
</li>
</ul>
<p>在创建Deployment时，需要指定一些重要的参数，包括要创建的Pod的镜像、Pod的副本数量、更新策略、Pod的标签等等。</p>
<ul>
<li>ReplicaSet：<ul>
<li>Deployment是高级控制器，定义应用程序的期望状态，控制ReplicaSet；ReplicaSet是低级控制器，确保Pod数量与期望状态一致，控制pod；Pod承载应用程序或服务</li>
<li>也可以认为，Pod实现程序功能，ReplicaSet加入副本控制，Deployment再加入滚动更新，每一次封装带来更高级更抽象的功能</li>
<li>水平扩展/收缩时只需要ReplicaSet改变replicas</li>
<li>滚动更新则会新建新的ReplicaSet，逐步实现两个ReplicaSet的此消彼长</li>
<li>旧ReplicaSet实现版本控制</li>
</ul>
</li>
</ul>
<p>Deployment主要应用于需要管理和维护的应用程序，尤其是那些需要不断迭代更新的业务。具体来说，Deployment适用于以下场景：</p>
<ul>
<li>Web应用程序：Web应用程序通常需要频繁地升级和扩展，以应对不断变化的用户需求和流量峰值。使用Deployment可以方便地管理Web应用程序的部署、升级和水平扩展，确保应用程序始终处于可用状态。</li>
<li>云原生应用程序：云原生应用程序通常由多个微服务组成，需要进行复杂的编排和管理。使用Deployment可以方便地管理微服务的部署和升级，确保微服务之间的兼容性和协调性。</li>
<li>大数据应用程序：大数据应用程序通常需要管理大量的容器和集群资源，以处理海量数据和实时查询。使用Deployment可以方便地管理大数据应用程序的部署和扩展，确保应用程序的高可用性和性能。</li>
<li>分布式系统：分布式系统通常需要管理多个节点和组件，以实现复杂的协同和通信。使用Deployment可以方便地管理分布式系统的部署和升级，确保各个节点和组件之间的一致性和稳定性。<br>总之，Deployment适用于各种需要管理和维护的应用程序，特别是那些需要频繁迭代更新和水平扩展的业务。通过使用Deployment，我们可以方便地管理应用程序的生命周期，并确保应用程序始终处于可用状态。</li>
</ul>
<h4 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h4><p>Kubernetes中的StatefulSet是一种控制器，用于管理有状态的应用程序，例如数据库或消息队列。<br>与Deployment不同，StatefulSet的Pods具有固定的顺序和唯一的标识符。每个Pod都有一个稳定的网络标识符（即DNS名称），可以通过该标识符进行查找和访问。这使得对于有状态应用程序，如数据库，每个实例的数据持久性更加容易实现，确保了应用程序的稳定性和可靠性。</p>
<ul>
<li><p>支持有状态应用：每个pod有了编号，不是完全一样，记录状态，然后在Pod被重新创建时，能够为新Pod恢复这些状态。</p>
<ul>
<li>拓扑状态：pod按照一定顺序创建，且删掉后新创建的pod要与原来的pod有相同的网络标识</li>
<li>存储状态：不同实例可以使用不同的存储数据，PVC，PV</li>
</ul>
</li>
<li><p>常见例子：</p>
<ul>
<li>通过若干个有顺序的MySQL的pod来管理数据，实例的名称将分别为mysql-0、mysql-1、mysql-2、…</li>
<li>在Zookeeper集群中，每个节点都有唯一的ID和状态，节点之间需要进行数据同步和协调，因此需要保证每个节点的启动顺序和稳定性。</li>
</ul>
</li>
</ul>
<h4 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h4><p>Kubernetes的DaemonSet对象是一种用于管理集群节点上的守护进程的控制器对象。守护进程是一种在节点上运行的后台进程，可以执行一些系统级别的任务，例如监控、日志收集、安全检查等。<br>DaemonSet会在每个节点上自动创建一个Pod，确保该节点上运行指定的守护进程。当一个新节点加入集群时，它也会自动创建一个Pod。如果某个节点被删除或不可用，它上面的Pod也会被自动删除。<br>DaemonSet与其他控制器对象的不同之处在于，它的Pod是针对每个节点而不是每个副本集（ReplicaSet）来管理的。这使得它非常适合用于运行具有单节点依赖性的任务，如日志收集和监控。<br>在创建DaemonSet对象时，需要指定一个Pod模板，以及要运行的守护进程的镜像和其他配置参数。如果需要对所有节点运行的守护进程进行更改，则可以更新DaemonSet的Pod模板。这将导致所有Pod被重启并更新为新的配置。<br>总之，Kubernetes的DaemonSet对象提供了一种简单而可靠的方法来管理集群节点上的守护进程，从而实现更高效的集群管理。</p>
<p>特点：</p>
<ul>
<li>这个Pod运行在Kubernetes集群里的每一个节点（Node）上；</li>
<li>每个节点上只有一个这样的Pod实例；</li>
<li>当有新的节点加入Kubernetes集群后，该Pod会自动地在新节点上被创建出来；而当旧节点被删除后，它上面的Pod也相应地会被回收掉。</li>
<li>常见应用：网络插件、存储插件、监控组件、日志组件</li>
</ul>
<h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h4><p>Job对象是用于在集群中运行一次性任务的控制器，如批处理作业或数据处理任务。当一个Job对象创建时，它会创建一个或多个Pod来执行任务，并在任务完成后自动删除Pod。如果任务失败，Job将重新启动一个新的Pod以重新执行任务，直到任务成功或达到指定的重试次数。</p>
<ul>
<li>常见字段：<ul>
<li>spec.parallelism：它定义的是一个Job在任意时间最多可以启动多少个Pod同时运行</li>
<li>spec.completions：它定义的是Job至少要完成的Pod数目，即Job的最小完成数。</li>
<li>spec.activeDeadlineSeconds：最长运行时间</li>
<li>spec.backoffLimit：重试次数</li>
</ul>
</li>
</ul>
<h4 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h4><p>CronJob对象则是用于定期执行任务的控制器。与Job不同，CronJob会在指定的时间间隔内按照预定的计划运行任务，如每天、每周或每月。CronJob会创建一个Job对象来运行任务，并根据指定的计划进行管理和更新。</p>
<ul>
<li>常用字段：<ul>
<li>spec.concurrencyPolicy：某个Job还没有执行完，是否创建新Job</li>
</ul>
</li>
</ul>
<h4 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h4><p>Operator是Kubernetes对象的一种扩展，它利用Kubernetes API和自定义资源扩展了Kubernetes对象，以便自动化管理Kubernetes对象。</p>
<p>在Kubernetes中，对象是基本的API概念，它们用于表示Kubernetes集群中的状态和配置。例如，Pod、Service、Deployment等都是Kubernetes对象。Kubernetes对象具有一组预定义的字段，用于描述对象的状态和配置，以及一组API操作，用于管理对象的生命周期。通过使用Kubernetes API，可以创建、更新、扩展和删除Kubernetes对象。</p>
<p>Operator利用Kubernetes API和自定义资源，以自己的方式扩展了Kubernetes对象。自定义资源是一种自定义的Kubernetes对象，可以用来表示自定义的应用程序或服务。自定义资源由Operator定义和管理，并且可以包含自定义字段和自定义行为，以便满足应用程序的特定需求。控制器负责监视自定义资源的状态，并根据需要自动管理应用程序的生命周期。</p>
<p>因此，Operator和Kubernetes对象是密切相关的。Operator使用Kubernetes API和自定义资源扩展了Kubernetes对象，以便自动化管理应用程序的生命周期。Operator本身也是Kubernetes对象，可以由Kubernetes API创建、更新、扩展和删除，以及通过标准的Kubernetes对象授权和访问控制机制进行管理。通过利用Operator，可以更好地管理Kubernetes对象，提高应用程序的可靠性和可维护性。</p>
<h3 id="作业调度"><a href="#作业调度" class="headerlink" title="作业调度"></a>作业调度</h3><h4 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h4><ul>
<li>requests设置pod的资源最小量，在调度的时候发挥作用</li>
<li>limits设置pod的资源最大值，设置Cgroups，在运行的时候限制上限</li>
<li>可压缩资源（CPU）不足limits时：根据requests按比例分配分配</li>
<li>不可压缩资源（内存）不足limits时：根据优先级驱逐<ul>
<li>优先驱逐Request==Limit==0的Pod</li>
<li>其次驱逐0&lt; Request &lt; Limit &lt; Infinity</li>
<li>0 &lt; Request == Limit会保留</li>
</ul>
</li>
</ul>
<h4 id="默认调度器"><a href="#默认调度器" class="headerlink" title="默认调度器"></a>默认调度器</h4><ul>
<li>调度过程：<ul>
<li>从所有的节点中，根据调度算法挑选出所有可以运行该Pod的节点；<ul>
<li>多种算法并行过滤，不同node并行</li>
</ul>
</li>
<li>再根据调度算法挑选一个最符合条件的节点作为最终结果。</li>
</ul>
</li>
</ul>
<h4 id="优先级与抢占"><a href="#优先级与抢占" class="headerlink" title="优先级与抢占"></a>优先级与抢占</h4><ul>
<li>pod可以设置优先级</li>
<li>高优先级的pod在调度队列中优先被调度</li>
<li>高优先级的pod调度失败后可以抢占低优先级的pod</li>
</ul>
<h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3><h4 id="service"><a href="#service" class="headerlink" title="service"></a>service</h4><p>Kubernetes (k8s) 中的 Service 是一种抽象，用于定义一组 Pod 如何访问应用程序。Service 提供了一个虚拟的 IP 地址和一个 DNS 名称，用于与 Pod 进行通信，它可以帮助应用程序隐藏底层的 Pod 实现细节。Service 可以通过多种方式将请求路由到目标 Pod，例如：负载均衡、DNS 轮询和客户端 IP 等方式。</p>
<p>在 Kubernetes 集群中，Pod 的 IP 地址是动态分配的，这使得直接访问 Pod 有一定的不可靠性。Service 提供了一个固定的 IP 地址和一个 DNS 名称，它们将永久地与该 Service 关联。这使得应用程序可以通过 Service 访问一组 Pod，而不必关心 Pod 的实际 IP 地址。</p>
<ul>
<li>主要解决pod动态变化，提供统一的访问入口，实现：<ul>
<li>服务发现</li>
<li>负载均衡</li>
</ul>
</li>
<li>通过标签labels来关联pod</li>
<li>ClusterIP：分配一个稳定的集群内部IP，可以通过这个IP+设置的端口访问pod</li>
<li>NodePort：在每个node上监听一个端口来访问服务。需要自己规划端口。</li>
<li>LoadBalancer：在NodePort的基础上增加一个公网的负载均衡器，从统一的IP进行访问，由LoadBalancer转发到node</li>
</ul>
<h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h4><ul>
<li>基于service，对外提供域名访问和负载均衡</li>
</ul>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="服务器基本环境"><a href="#服务器基本环境" class="headerlink" title="服务器基本环境"></a>服务器基本环境</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 关闭防火墙</span>
system stop firewalld
system disable firewalld

<span class="token comment"># 关闭selinux(Linux的一个安全机制)</span>
<span class="token comment"># 永久</span>
<span class="token function">sed</span> -i <span class="token string">'s/enforcing/disable/'</span> /etc/selinux/config 
<span class="token comment"># 临时</span>
setenforce <span class="token number">0</span>

<span class="token comment"># 关闭swap</span>
<span class="token comment"># 永久</span>
<span class="token function">vim</span> /etc/fatab <span class="token comment"># 注释交换分区的那一行</span>
<span class="token comment"># 临时</span>
swapoff -a

<span class="token comment"># 设置主机名</span>
hostnamectl set-hostname <span class="token operator">&lt;</span>hostname<span class="token operator">></span>

<span class="token comment"># 在master添加host</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
ip1 name1
ip2 name2
ip3 name3
EOF</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="kubeadm"><a href="#kubeadm" class="headerlink" title="kubeadm"></a>kubeadm</h4><ul>
<li>通过kubeadm init和kubeadm join快速部署k8s集群</li>
<li>kubeadm init创建master节点</li>
<li>kubeadm join &lt;master节点的IP和端口&gt; 将一个节点加入到当前集群</li>
</ul>
<h4 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h4><ul>
<li>通过二进制包，手动部署每个组件，组成k8s集群</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">万川</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://notego.top/2021/04/17/yun-yuan-sheng/">http://notego.top/2021/04/17/yun-yuan-sheng/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">万川</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                    <span class="chip bg-color">微服务</span>
                                </a>
                            
                                <a href="/tags/%E5%AE%B9%E5%99%A8/">
                                    <span class="chip bg-color">容器</span>
                                </a>
                            
                                <a href="/tags/Docker/">
                                    <span class="chip bg-color">Docker</span>
                                </a>
                            
                                <a href="/tags/kubernetes/">
                                    <span class="chip bg-color">kubernetes</span>
                                </a>
                            
                                <a href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/">
                                    <span class="chip bg-color">模块化</span>
                                </a>
                            
                                <a href="/tags/%E7%8B%AC%E7%AB%8B%E9%83%A8%E7%BD%B2/">
                                    <span class="chip bg-color">独立部署</span>
                                </a>
                            
                                <a href="/tags/%E6%9D%BE%E8%80%A6%E5%90%88/">
                                    <span class="chip bg-color">松耦合</span>
                                </a>
                            
                                <a href="/tags/%E5%BA%B7%E5%A8%81%E6%B3%95%E5%88%99/">
                                    <span class="chip bg-color">康威法则</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你好，同行的有缘人</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/10/20/go/">
                    <div class="card-image">
                        
                        <img src="/medias/image/go.jpg" class="responsive-img" alt="Go">
                        
                        <span class="card-title">Go</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            简单、高效、并发
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-10-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" class="post-category">
                                    编程语言
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/04/08/dao-de-jing-bi-ji/">
                    <div class="card-image">
                        
                        <img src="/medias/image/%E3%80%8A%E9%81%93%E5%BE%B7%E7%BB%8F%E3%80%8B.jpg" class="responsive-img" alt="《道德经》笔记">
                        
                        <span class="card-title">《道德经》笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            致虚极，守静笃
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-04-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="post-category">
                                    读书笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E9%81%93/">
                        <span class="chip bg-color">道</span>
                    </a>
                    
                    <a href="/tags/%E8%87%AA%E7%84%B6/">
                        <span class="chip bg-color">自然</span>
                    </a>
                    
                    <a href="/tags/%E8%80%81%E5%AD%90/">
                        <span class="chip bg-color">老子</span>
                    </a>
                    
                    <a href="/tags/%E6%97%A0%E4%B8%BA/">
                        <span class="chip bg-color">无为</span>
                    </a>
                    
                    <a href="/tags/%E5%BE%B7/">
                        <span class="chip bg-color">德</span>
                    </a>
                    
                    <a href="/tags/%E6%97%A0/">
                        <span class="chip bg-color">无</span>
                    </a>
                    
                    <a href="/tags/%E4%B8%8A%E5%96%84%E8%8B%A5%E6%B0%B4/">
                        <span class="chip bg-color">上善若水</span>
                    </a>
                    
                    <a href="/tags/%E5%96%84/">
                        <span class="chip bg-color">善</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('20')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 方寸田园<br />'
            + '文章作者: 万川<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2023</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">万川</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">197.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "3";
                    var startDate = "31";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wanc97" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:wanc97@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3221927185" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3221927185" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI4MzEzNjIxNw==#wechat_redirect" class="tooltipped" target="_blank" data-tooltip="微信联系我: W3221927185" data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

    <!-- 雪花特效 --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</body>

</html>
